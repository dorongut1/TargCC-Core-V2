// <auto-generated>
//     This code was generated by TargCC.Core.Generators v2.0
//     Generated from table: dbo.CustomerPerformance
//     Generation date: 2025-12-18 08:11:21
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

namespace UpayCard.RiskManagement.Infrastructure.Repositories;

using System.Data;
using System.Threading;
using System.Threading.Tasks;
using Dapper;
using Microsoft.Extensions.Logging;
using UpayCard.RiskManagement.Domain.Entities;
using UpayCard.RiskManagement.Domain.Interfaces;

/// <summary>
/// Repository implementation for CustomerPerformance entity data access operations.
/// </summary>
/// <remarks>
/// <para>
/// This repository provides data access for the CustomerPerformance entity using Dapper
/// for stored procedure calls. All operations are async and support cancellation.
/// </para>
/// </remarks>
public class CustomerPerformanceRepository : ICustomerPerformanceRepository
{
    private readonly IDbConnection _connection;
    private readonly ILogger<CustomerPerformanceRepository> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="CustomerPerformanceRepository"/> class.
    /// </summary>
    /// <param name="connection">Database connection for Dapper operations.</param>
    /// <param name="logger">Logger for tracking repository operations.</param>
    public CustomerPerformanceRepository(IDbConnection connection, ILogger<CustomerPerformanceRepository> logger)
    {
        _connection = connection ?? throw new ArgumentNullException(nameof(connection));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task<CustomerPerformance?> GetByIdAsync(long id, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Getting CustomerPerformance by ID: {Id}", id);

        try
        {
            var result = await _connection.QueryFirstOrDefaultAsync<CustomerPerformance>(
                "SP_GetCustomerPerformanceByID",
                new { ID = id },
                commandType: CommandType.StoredProcedure);

            _logger.LogDebug("CustomerPerformance found: {Found}", result != null);
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting CustomerPerformance by ID: {Id}", id);
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task<IEnumerable<CustomerPerformance>> GetAllAsync(int? skip = null, int? take = null, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Getting all CustomerPerformance entities. Skip: {Skip}, Take: {Take}", skip, take);

        try
        {
            var result = await _connection.QueryAsync<CustomerPerformance>(
                "SP_GetAllCustomerPerformances",
                new { Skip = skip, Take = take },
                commandType: CommandType.StoredProcedure);

            _logger.LogDebug("Retrieved {Count} CustomerPerformance entities", result.Count());
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting all CustomerPerformance entities");
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task<IEnumerable<CustomerPerformance>> GetFilteredAsync(long? customerID = null, int? skip = null, int? take = null, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Getting filtered CustomerPerformance entities");

        try
        {
            var parameters = new {
                CustomerID = customerID,
                Skip = skip,
                Take = take
            };

            var result = await _connection.QueryAsync<CustomerPerformance>(
                "SP_GetFilteredCustomerPerformances",
                parameters,
                commandType: CommandType.StoredProcedure);

            _logger.LogDebug("Retrieved {Count} filtered CustomerPerformance entities", result.Count());
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting filtered CustomerPerformance entities");
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task AddAsync(CustomerPerformance entity, CancellationToken cancellationToken = default)
    {
        if (entity == null)
        {
            throw new ArgumentNullException(nameof(entity));
        }

        _logger.LogDebug("Adding new CustomerPerformance");

        try
        {
            var parameters = new DynamicParameters();
            parameters.Add("@TableName_CustomerPerformance", entity.TableName_CustomerPerformance);
            parameters.Add("@CustomerID", entity.CustomerID);
            parameters.Add("@spt_NumberOfActivePrepaidCards", entity.NumberOfActivePrepaidCardsSeparate);
            parameters.Add("@spt_PrepaidCardBalanceSum", entity.PrepaidCardBalanceSumSeparate);
            parameters.Add("@spt_WalletBalanceRaw", entity.WalletBalanceRawSeparate);
            parameters.Add("@spt_WalletBalanceCommitted", entity.WalletBalanceCommittedSeparate);
            parameters.Add("@spt_LastTimeEnteredCustomerApplication", entity.LastTimeEnteredCustomerApplicationSeparate);
            parameters.Add("@spt_LastTimeLoadedCard", entity.LastTimeLoadedCardSeparate);
            parameters.Add("@spt_LastTimeDidWalletTransfer", entity.LastTimeDidWalletTransferSeparate);
            parameters.Add("@DeletedBy", entity.DeletedBy);
            parameters.Add("@DeletedOn", entity.DeletedOn);
            parameters.Add("@UpdatingLoginID", entity.UpdatingLoginID);
            parameters.Add("@AddedBy", entity.AddedBy);

            await _connection.ExecuteAsync(
                "SP_AddCustomerPerformance",
                parameters,
                commandType: CommandType.StoredProcedure);

            _logger.LogInformation("CustomerPerformance added successfully");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error adding CustomerPerformance");
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task UpdateAsync(CustomerPerformance entity, CancellationToken cancellationToken = default)
    {
        if (entity == null)
        {
            throw new ArgumentNullException(nameof(entity));
        }

        _logger.LogDebug("Updating CustomerPerformance with ID: {Id}", entity.ID);

        try
        {
            var parameters = new DynamicParameters();
            parameters.Add("@ID", entity.ID);
            parameters.Add("@TableName_CustomerPerformance", entity.TableName_CustomerPerformance);
            parameters.Add("@CustomerID", entity.CustomerID);
            parameters.Add("@spt_NumberOfActivePrepaidCards", entity.NumberOfActivePrepaidCardsSeparate);
            parameters.Add("@spt_PrepaidCardBalanceSum", entity.PrepaidCardBalanceSumSeparate);
            parameters.Add("@spt_WalletBalanceRaw", entity.WalletBalanceRawSeparate);
            parameters.Add("@spt_WalletBalanceCommitted", entity.WalletBalanceCommittedSeparate);
            parameters.Add("@spt_LastTimeEnteredCustomerApplication", entity.LastTimeEnteredCustomerApplicationSeparate);
            parameters.Add("@spt_LastTimeLoadedCard", entity.LastTimeLoadedCardSeparate);
            parameters.Add("@spt_LastTimeDidWalletTransfer", entity.LastTimeDidWalletTransferSeparate);
            parameters.Add("@DeletedBy", entity.DeletedBy);
            parameters.Add("@DeletedOn", entity.DeletedOn);
            parameters.Add("@UpdatingLoginID", entity.UpdatingLoginID);
            parameters.Add("@ChangedBy", entity.ChangedBy);

            await _connection.ExecuteAsync(
                "SP_UpdateCustomerPerformance",
                parameters,
                commandType: CommandType.StoredProcedure);

            _logger.LogInformation("CustomerPerformance updated successfully. ID: {Id}", entity.ID);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error updating CustomerPerformance with ID: {Id}", entity.ID);
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task DeleteAsync(long id, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Deleting CustomerPerformance with ID: {Id}", id);

        try
        {
            await _connection.ExecuteAsync(
                "SP_DeleteCustomerPerformance",
                new { ID = id },
                commandType: CommandType.StoredProcedure);

            _logger.LogInformation("CustomerPerformance deleted successfully. ID: {Id}", id);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error deleting CustomerPerformance with ID: {Id}", id);
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task<CustomerPerformance?> GetByCustomerIDAsync(long customerID, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Getting CustomerPerformance by CustomerID");

        try
        {
            var result = await _connection.QueryFirstOrDefaultAsync<CustomerPerformance>(
                "SP_GetCustomerPerformanceByCustomerID",
                new { CustomerID = customerID },
                commandType: CommandType.StoredProcedure);

            _logger.LogDebug("CustomerPerformance found: {Found}", result != null);
            return result;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting CustomerPerformance by CustomerID");
            throw;
        }
    }

    /// <inheritdoc/>
    public async System.Threading.Tasks.Task UpdateAggregatesAsync(long id, decimal prepaidCardAmountLoadedToday, decimal prepaidCardAmountLoadedThisMonth, int prepaidCardLoadCountToday, int prepaidCardLoadCountThisMonth, decimal prepaidCardAmountLoadedLast6Months, decimal prepaidCardTotalAmountLoaded, int prepaidCardTotalLoadCount, decimal walletWithdrawalAmtViaCreditCardToday, decimal walletWithdrawalAmtViaCreditCardThisMonth, decimal walletWithdrawalAmtViaBankToday, decimal walletWithdrawalAmtViaBankThisMonth, decimal walletWithdrawalAmtViaChangerToday, decimal walletWithdrawalAmtViaChangerThisMonth, int walletWithdrawalCountViaCreditCardToday, int walletWithdrawalCountViaCreditCardThisMonth, int walletWithdrawalCountViaBankToday, int walletWithdrawalCountViaBankThisMonth, int walletWithdrawalCountViaChangerToday, int walletWithdrawalCountViaChangerThisMonth, decimal walletTransferPaidAmtToday, decimal walletTransferPaidAmtThisMonth, int walletTransferPaidCountToday, int walletTransferPaidCountThisMonth, decimal walletTotalTransferPaidAmount, int walletTotalTransferPaidCount, int walletTransferPaidCountLast7Days, decimal walletDepositAmtViaCreditCardThisMonth, decimal walletDepositAmtViaCreditCardToday, decimal walletDepositAmtViaBankToday, decimal walletDepositAmtViaBankThisMonth, decimal walletDepositAmtViaChangerToday, decimal walletDepositAmtViaChangerThisMonth, int walletDepositCountViaCreditCardToday, int walletDepositCountViaCreditCardThisMonth, int walletDepositCountViaBankToday, int walletDepositCountViaBankThisMonth, int walletDepositCountViaChangerToday, int walletDepositCountViaChangerThisMonth, decimal walletTransferReceivedAmtToday, decimal walletTransferReceivedAmtThisMonth, int walletTransferReceivedCountToday, int walletTransferReceivedCountThisMonth, decimal walletTotalTransferReceivedAmount, decimal walletTotalTransferReceivedCount, decimal walletTransferPaidAmtLast7Days, decimal totalTransferredToWallet1Month, decimal totalTransferredToWallet6Months, decimal totalTransferredToWallet, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Updating CustomerPerformance aggregates for ID: {Id}", id);

        try
        {
            await _connection.ExecuteAsync(
                "SP_UpdateCustomerPerformanceAggregates",
                new { ID = id, PrepaidCardAmountLoadedToday = prepaidCardAmountLoadedToday, PrepaidCardAmountLoadedThisMonth = prepaidCardAmountLoadedThisMonth, PrepaidCardLoadCountToday = prepaidCardLoadCountToday, PrepaidCardLoadCountThisMonth = prepaidCardLoadCountThisMonth, PrepaidCardAmountLoadedLast6Months = prepaidCardAmountLoadedLast6Months, PrepaidCardTotalAmountLoaded = prepaidCardTotalAmountLoaded, PrepaidCardTotalLoadCount = prepaidCardTotalLoadCount, WalletWithdrawalAmtViaCreditCardToday = walletWithdrawalAmtViaCreditCardToday, WalletWithdrawalAmtViaCreditCardThisMonth = walletWithdrawalAmtViaCreditCardThisMonth, WalletWithdrawalAmtViaBankToday = walletWithdrawalAmtViaBankToday, WalletWithdrawalAmtViaBankThisMonth = walletWithdrawalAmtViaBankThisMonth, WalletWithdrawalAmtViaChangerToday = walletWithdrawalAmtViaChangerToday, WalletWithdrawalAmtViaChangerThisMonth = walletWithdrawalAmtViaChangerThisMonth, WalletWithdrawalCountViaCreditCardToday = walletWithdrawalCountViaCreditCardToday, WalletWithdrawalCountViaCreditCardThisMonth = walletWithdrawalCountViaCreditCardThisMonth, WalletWithdrawalCountViaBankToday = walletWithdrawalCountViaBankToday, WalletWithdrawalCountViaBankThisMonth = walletWithdrawalCountViaBankThisMonth, WalletWithdrawalCountViaChangerToday = walletWithdrawalCountViaChangerToday, WalletWithdrawalCountViaChangerThisMonth = walletWithdrawalCountViaChangerThisMonth, WalletTransferPaidAmtToday = walletTransferPaidAmtToday, WalletTransferPaidAmtThisMonth = walletTransferPaidAmtThisMonth, WalletTransferPaidCountToday = walletTransferPaidCountToday, WalletTransferPaidCountThisMonth = walletTransferPaidCountThisMonth, WalletTotalTransferPaidAmount = walletTotalTransferPaidAmount, WalletTotalTransferPaidCount = walletTotalTransferPaidCount, WalletTransferPaidCountLast7Days = walletTransferPaidCountLast7Days, WalletDepositAmtViaCreditCardThisMonth = walletDepositAmtViaCreditCardThisMonth, WalletDepositAmtViaCreditCardToday = walletDepositAmtViaCreditCardToday, WalletDepositAmtViaBankToday = walletDepositAmtViaBankToday, WalletDepositAmtViaBankThisMonth = walletDepositAmtViaBankThisMonth, WalletDepositAmtViaChangerToday = walletDepositAmtViaChangerToday, WalletDepositAmtViaChangerThisMonth = walletDepositAmtViaChangerThisMonth, WalletDepositCountViaCreditCardToday = walletDepositCountViaCreditCardToday, WalletDepositCountViaCreditCardThisMonth = walletDepositCountViaCreditCardThisMonth, WalletDepositCountViaBankToday = walletDepositCountViaBankToday, WalletDepositCountViaBankThisMonth = walletDepositCountViaBankThisMonth, WalletDepositCountViaChangerToday = walletDepositCountViaChangerToday, WalletDepositCountViaChangerThisMonth = walletDepositCountViaChangerThisMonth, WalletTransferReceivedAmtToday = walletTransferReceivedAmtToday, WalletTransferReceivedAmtThisMonth = walletTransferReceivedAmtThisMonth, WalletTransferReceivedCountToday = walletTransferReceivedCountToday, WalletTransferReceivedCountThisMonth = walletTransferReceivedCountThisMonth, WalletTotalTransferReceivedAmount = walletTotalTransferReceivedAmount, WalletTotalTransferReceivedCount = walletTotalTransferReceivedCount, WalletTransferPaidAmtLast7Days = walletTransferPaidAmtLast7Days, TotalTransferredToWallet1Month = totalTransferredToWallet1Month, TotalTransferredToWallet6Months = totalTransferredToWallet6Months, TotalTransferredToWallet = totalTransferredToWallet },
                commandType: CommandType.StoredProcedure);

            _logger.LogInformation("CustomerPerformance aggregates updated successfully. ID: {Id}", id);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error updating CustomerPerformance aggregates. ID: {Id}", id);
            throw;
        }
    }

    /// <inheritdoc/>
    public async Task<bool> ExistsAsync(long id, CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Checking if CustomerPerformance exists with ID: {Id}", id);

        try
        {
            var result = await _connection.QueryFirstOrDefaultAsync<CustomerPerformance>(
                "SP_GetCustomerPerformanceByID",
                new { ID = id },
                commandType: CommandType.StoredProcedure);

            bool exists = result != null;
            _logger.LogDebug("CustomerPerformance exists: {Exists}", exists);
            return exists;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error checking if CustomerPerformance exists. ID: {Id}", id);
            throw;
        }
    }
}
