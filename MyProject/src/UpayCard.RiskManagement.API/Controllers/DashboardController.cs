// <auto-generated>
//     This code was generated by TargCC Dashboard Controller Generator.
//     Generated: 2025-12-11 14:19:38
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using UpayCard.RiskManagement.Domain.Interfaces;

namespace UpayCard.RiskManagement.API.Controllers
{
    /// <summary>
    /// Dashboard statistics DTO.
    /// </summary>
    public class DashboardStatsDto
    {
        public int TotalReport2s { get; set; }
        public decimal report2sGrowth { get; set; }
        public int TotalActiveRestrictionss { get; set; }
        public decimal activeRestrictionssGrowth { get; set; }
        public int TotalBackofficeTransactions { get; set; }
        public decimal backofficeTransactionsGrowth { get; set; }
    }

    /// <summary>
    /// Recent activity DTO.
    /// </summary>
    public class ActivityDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Time { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }


    /// <summary>
    /// Dashboard API controller providing statistics and recent activity.
    /// </summary>
    [ApiController]
    [Route("api/[controller]")]
    [Produces("application/json")]
    public class DashboardController : ControllerBase
    {
        private readonly IReport2Repository _report2Repository;
        private readonly IActiveRestrictionsRepository _activeRestrictionsRepository;
        private readonly IBackofficeTransactionRepository _backofficeTransactionRepository;
        private readonly ILogger<DashboardController> _logger;

        /// <summary>
        /// Initializes a new instance of the <see cref="DashboardController"/> class.
        /// </summary>
        /// <param name="report2Repository">Repository for Report2.</param>
        /// <param name="activeRestrictionsRepository">Repository for ActiveRestrictions.</param>
        /// <param name="backofficeTransactionRepository">Repository for BackofficeTransaction.</param>
        /// <param name="logger">Logger instance.</param>
        public DashboardController(
            IReport2Repository report2Repository,
            IActiveRestrictionsRepository activeRestrictionsRepository,
            IBackofficeTransactionRepository backofficeTransactionRepository,
            ILogger<DashboardController> logger)
        {
            _report2Repository = report2Repository ?? throw new ArgumentNullException(nameof(report2Repository));
            _activeRestrictionsRepository = activeRestrictionsRepository ?? throw new ArgumentNullException(nameof(activeRestrictionsRepository));
            _backofficeTransactionRepository = backofficeTransactionRepository ?? throw new ArgumentNullException(nameof(backofficeTransactionRepository));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        /// <summary>
        /// Gets dashboard statistics including entity counts and growth metrics.
        /// </summary>
        /// <returns>Dashboard statistics.</returns>
        [HttpGet("stats")]
        [ProducesResponseType(typeof(DashboardStatsDto), 200)]
        public async Task<ActionResult<DashboardStatsDto>> GetStats()
        {
            try
            {
                var stats = new DashboardStatsDto
                {
                    TotalReport2s = (await _report2Repository.GetAllAsync().ConfigureAwait(false)).Count(),
                    report2sGrowth = CalculateGrowth(new Random().Next(1, 20)),
                    TotalActiveRestrictionss = (await _activeRestrictionsRepository.GetAllAsync().ConfigureAwait(false)).Count(),
                    activeRestrictionssGrowth = CalculateGrowth(new Random().Next(1, 20)),
                    TotalBackofficeTransactions = (await _backofficeTransactionRepository.GetAllAsync().ConfigureAwait(false)).Count(),
                    backofficeTransactionsGrowth = CalculateGrowth(new Random().Next(1, 20))
                };

                return Ok(stats);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error fetching dashboard statistics");
                return StatusCode(500, "An error occurred while fetching statistics");
            }
        }

        /// <summary>
        /// Gets recent activity events.
        /// </summary>
        /// <returns>Collection of recent activities.</returns>
        [HttpGet("recent-activity")]
        [ProducesResponseType(typeof(IEnumerable<ActivityDto>), 200)]
        public ActionResult<IEnumerable<ActivityDto>> GetRecentActivity()
        {
            try
            {
                // Sample activity data - in production, this would query an audit log or activity table
                var activities = new List<ActivityDto>
                {
                    new ActivityDto { Id = 1, Title = "New record created", Time = "5 minutes ago", Icon = "✓" },
                    new ActivityDto { Id = 2, Title = "Record updated", Time = "15 minutes ago", Icon = "✎" },
                    new ActivityDto { Id = 3, Title = "Record deleted", Time = "1 hour ago", Icon = "✗" },
                    new ActivityDto { Id = 4, Title = "Bulk import completed", Time = "2 hours ago", Icon = "↓" },
                    new ActivityDto { Id = 5, Title = "System backup completed", Time = "3 hours ago", Icon = "◉" }
                };

                return Ok(activities);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error fetching recent activity");
                return StatusCode(500, "An error occurred while fetching activity");
            }
        }

        /// <summary>
        /// Calculates a growth percentage (placeholder logic).
        /// </summary>
        private static decimal CalculateGrowth(int value)
        {
            // In production, compare current period vs previous period
            return Math.Round((decimal)value * 0.5m, 1);
        }
    }
}
