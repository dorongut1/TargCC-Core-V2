// <auto-generated>
//     This code was generated by TargCC
//     Generated for: Card (Handler)
//     Generation date: 2025-12-17 12:56:53
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using AutoMapper;
using MediatR;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using UpayCard.RiskManagement.Application.Common.Interfaces;
using UpayCard.RiskManagement.Application.Common.Models;
using UpayCard.RiskManagement.Application.DTOs;
using UpayCard.RiskManagement.Domain.Common;
using UpayCard.RiskManagement.Domain.Entities;
using UpayCard.RiskManagement.Domain.Interfaces;

namespace UpayCard.RiskManagement.Application.Features.Cards.Queries;

/// <summary>
/// Handles the GetCardsQuery request with server-side filtering, sorting, and pagination.
/// </summary>
public class GetCardsHandler : IRequestHandler<GetCardsQuery, Result<PagedResult<CardDto>>>
{
    private readonly IApplicationDbContext _context;
    private readonly IMapper _mapper;
    private readonly ILogger<GetCardsHandler> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="GetCardsHandler"/> class.
    /// </summary>
    public GetCardsHandler(
        IApplicationDbContext context,
        IMapper mapper,
        ILogger<GetCardsHandler> logger)
    {
        _context = context ?? throw new ArgumentNullException(nameof(context));
        _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public async Task<Result<PagedResult<CardDto>>> Handle(GetCardsQuery request, CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(request);

        _logger.LogDebug("Getting Cards - Page: {Page}, Size: {Size}, SortBy: {SortBy}", request.Page, request.PageSize, request.SortBy);

        try
        {
            var query = _context.Cards.AsQueryable();

            // Apply filters
            query = ApplyFilters(query, request.Filters);

            // Get total count BEFORE pagination
            var totalCount = await query.CountAsync(cancellationToken);

            // Apply sorting
            query = ApplySorting(query, request.SortBy, request.SortDirection);

            // Apply pagination
            query = query
                .Skip((request.Page - 1) * request.PageSize)
                .Take(request.PageSize);

            var entities = await query.ToListAsync(cancellationToken);
            var dtos = _mapper.Map<List<CardDto>>(entities);

            var result = new PagedResult<CardDto>
            {
                Items = dtos,
                TotalCount = totalCount,
                Page = request.Page,
                PageSize = request.PageSize
            };

            _logger.LogDebug("Successfully retrieved {Count} of {Total} Cards", dtos.Count, totalCount);

            return Result<PagedResult<CardDto>>.Success(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving Cards");
            throw;
        }
    }

    private static IQueryable<Card> ApplyFilters(IQueryable<Card> query, CardFilters? filters)
    {
        if (filters == null)
        {
            return query;
        }

        // TODO: Add filter logic based on table columns
        // Example:
        // if (!string.IsNullOrEmpty(filters.Name))
        // {
        //     query = query.Where(e => e.Name.Contains(filters.Name));
        // }

        return query;
    }

    private static IQueryable<Card> ApplySorting(IQueryable<Card> query, string? sortBy, string? sortDirection)
    {
        if (string.IsNullOrEmpty(sortBy))
        {
            return query.OrderBy(e => e.ID); // Default sort
        }

        var isDescending = sortDirection?.ToLower() == "desc";

        // TODO: Add sorting logic based on table columns
        return sortBy.ToLower() switch
        {
            "id" => isDescending ? query.OrderByDescending(e => e.ID) : query.OrderBy(e => e.ID),
            // Add more sortable columns here
            _ => query.OrderBy(e => e.ID) // Default to ID if unknown field
        };
    }
}
