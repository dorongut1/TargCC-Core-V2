// <auto-generated>
//     This code was generated by TargCC
//     Generated for: RiskRule (Handler)
//     Generation date: 2025-12-17 08:50:00
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using MediatR;
using Microsoft.Extensions.Logging;
using UpayCard.RiskManagement.Application.Common.Models;
using UpayCard.RiskManagement.Domain.Entities;
using UpayCard.RiskManagement.Domain.Interfaces;

namespace UpayCard.RiskManagement.Application.Features.RiskRules.Commands;

/// <summary>
/// Handles the CreateRiskRuleCommand request.
/// </summary>
public class CreateRiskRuleHandler : IRequestHandler<CreateRiskRuleCommand, Result<long>>
{
    private readonly IRiskRuleRepository _repository;
    private readonly ILogger<CreateRiskRuleHandler> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="CreateRiskRuleHandler"/> class.
    /// </summary>
    public CreateRiskRuleHandler(
        IRiskRuleRepository repository,
        ILogger<CreateRiskRuleHandler> logger)
    {
        _repository = repository ?? throw new ArgumentNullException(nameof(repository));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public async Task<Result<long>> Handle(CreateRiskRuleCommand request, CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(request);

        _logger.LogDebug("Creating new RiskRule");

        try
        {
            var entity = new RiskRule
            {
                TableName_RiskRule = request.TableName_RiskRule,
                RuleName = request.RuleName,
                RuleDescription = request.RuleDescription,
                enmMonitoredEntity = request.enmMonitoredEntity,
                ReferenceTable = request.ReferenceTable,
                ReferenceTransactionType = request.ReferenceTransactionType,
                enmThresholdType = request.enmThresholdType,
                ThresholdValue = request.ThresholdValue,
                MinimumTransactionAmount = request.MinimumTransactionAmount,
                MaximumTransactionAmount = request.MaximumTransactionAmount,
                enmBaselineScope = request.enmBaselineScope,
                BaselineReferenceTable = request.BaselineReferenceTable,
                MinimumBaselineCount = request.MinimumBaselineCount,
                enmTimePeriod = request.enmTimePeriod,
                enmAction = request.enmAction,
                ActionDurationDays = request.ActionDurationDays,
                enmBlockedActionType = request.enmBlockedActionType,
                ActionColorID = request.ActionColorID,
                ActionMaxAllowedAmount = request.ActionMaxAllowedAmount,
                AlertEmailAddresses = request.AlertEmailAddresses,
                AlertSMSNumbers = request.AlertSMSNumbers,
                CreateTaskForUserID = request.CreateTaskForUserID,
                enmSeverity = request.enmSeverity,
                IsActive = request.IsActive,
                DeletedOn = request.DeletedOn,
                DeletedBy = request.DeletedBy,
                UpdatingLoginID = request.UpdatingLoginID
            };

            await _repository.AddAsync(entity, cancellationToken);

            _logger.LogInformation("RiskRule created successfully with ID: {Id}", entity.ID);

            return Result<long>.Success(entity.ID);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error creating RiskRule");
            throw;
        }
    }
}
