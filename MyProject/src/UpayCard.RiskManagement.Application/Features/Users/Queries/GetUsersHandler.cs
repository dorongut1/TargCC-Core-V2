// <auto-generated>
//     This code was generated by TargCC
//     Generated for: c_User (Handler)
//     Generation date: 2025-12-17 14:47:40
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using AutoMapper;
using MediatR;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using UpayCard.RiskManagement.Application.Common.Interfaces;
using UpayCard.RiskManagement.Application.Common.Models;
using UpayCard.RiskManagement.Application.DTOs;
using UpayCard.RiskManagement.Domain.Common;
using UpayCard.RiskManagement.Domain.Entities;
using UpayCard.RiskManagement.Domain.Interfaces;

namespace UpayCard.RiskManagement.Application.Features.c_Users.Queries;

/// <summary>
/// Handles the GetUsersQuery request with server-side filtering, sorting, and pagination.
/// </summary>
public class GetUsersHandler : IRequestHandler<GetUsersQuery, Result<PagedResult<UserDto>>>
{
    private readonly IApplicationDbContext _context;
    private readonly IMapper _mapper;
    private readonly ILogger<GetUsersHandler> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="GetUsersHandler"/> class.
    /// </summary>
    public GetUsersHandler(
        IApplicationDbContext context,
        IMapper mapper,
        ILogger<GetUsersHandler> logger)
    {
        _context = context ?? throw new ArgumentNullException(nameof(context));
        _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public async Task<Result<PagedResult<UserDto>>> Handle(GetUsersQuery request, CancellationToken cancellationToken)
    {
        ArgumentNullException.ThrowIfNull(request);

        _logger.LogDebug("Getting c_Users - Page: {Page}, Size: {Size}, SortBy: {SortBy}", request.Page, request.PageSize, request.SortBy);

        try
        {
            var query = _context.Users.AsQueryable();

            // Apply filters
            query = ApplyFilters(query, request.Filters);

            // Get total count BEFORE pagination
            var totalCount = await query.CountAsync(cancellationToken);

            // Apply sorting
            query = ApplySorting(query, request.SortBy, request.SortDirection);

            // Apply pagination
            query = query
                .Skip((request.Page - 1) * request.PageSize)
                .Take(request.PageSize);

            var entities = await query.ToListAsync(cancellationToken);
            var dtos = _mapper.Map<List<UserDto>>(entities);

            var result = new PagedResult<UserDto>
            {
                Items = dtos,
                TotalCount = totalCount,
                Page = request.Page,
                PageSize = request.PageSize
            };

            _logger.LogDebug("Successfully retrieved {Count} of {Total} c_Users", dtos.Count, totalCount);

            return Result<PagedResult<UserDto>>.Success(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving c_Users");
            throw;
        }
    }

    private static IQueryable<User> ApplyFilters(IQueryable<User> query, UserFilters? filters)
    {
        if (filters == null)
        {
            return query;
        }

        // TODO: Add filter logic based on table columns
        // Example:
        // if (!string.IsNullOrEmpty(filters.Name))
        // {
        //     query = query.Where(e => e.Name.Contains(filters.Name));
        // }

        return query;
    }

    private static IQueryable<User> ApplySorting(IQueryable<User> query, string? sortBy, string? sortDirection)
    {
        if (string.IsNullOrEmpty(sortBy))
        {
            return query.OrderBy(e => e.ID); // Default sort
        }

        var isDescending = sortDirection?.ToLower() == "desc";

        // TODO: Add sorting logic based on table columns
        return sortBy.ToLower() switch
        {
            "id" => isDescending ? query.OrderByDescending(e => e.ID) : query.OrderBy(e => e.ID),
            // Add more sortable columns here
            _ => query.OrderBy(e => e.ID) // Default to ID if unknown field
        };
    }
}
