using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using TargCC.Core.Generators.DI;
using TargCC.Core.Interfaces.Models;
using TargCC.Core.Tests.TestHelpers;
using Xunit;

namespace TargCC.Core.Tests.Unit.Generators.DI;

/// <summary>
/// Unit tests for <see cref="DIRegistrationGenerator"/>.
/// </summary>
public class DIRegistrationGeneratorTests
{
    private readonly Mock<ILogger<DIRegistrationGenerator>> _loggerMock;
    private readonly DIRegistrationGenerator _generator;

    public DIRegistrationGeneratorTests()
    {
        _loggerMock = new Mock<ILogger<DIRegistrationGenerator>>();

        // Setup IsEnabled to return true for LoggerMessage.Define to work
        _loggerMock.Setup(x => x.IsEnabled(It.IsAny<LogLevel>())).Returns(true);

        _generator = new DIRegistrationGenerator(_loggerMock.Object);
    }

    [Fact]
    public void Constructor_WithValidLogger_CreatesInstance()
    {
        // Act
        var generator = new DIRegistrationGenerator(_loggerMock.Object);

        // Assert
        generator.Should().NotBeNull();
    }

    [Fact]
    public void Constructor_WithNullLogger_ThrowsArgumentNullException()
    {
        // Act
        Action act = () => new DIRegistrationGenerator(null!);

        // Assert
        act.Should().Throw<ArgumentNullException>()
            .WithParameterName("logger");
    }

    [Fact]
    public async Task GenerateAsync_WithNullSchema_ThrowsArgumentNullException()
    {
        // Act
        Func<Task> act = async () => await _generator.GenerateAsync(null!);

        // Assert
        await act.Should().ThrowAsync<ArgumentNullException>()
            .WithParameterName("schema");
    }

    // Replace all occurrences of .WithTable("TableName") with .WithTable(new Table { Name = "TableName" })
    // This assumes the Table class has a public property 'Name' of type string.

    [Fact]
    public async Task GenerateAsync_WithSingleTable_GeneratesBasicDIRegistration()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().NotBeNullOrEmpty();
        result.Should().Contain("public static class InfrastructureServiceRegistration");
        result.Should().Contain("public static IServiceCollection AddInfrastructure");
        result.Should().Contain("AddDbContext<ApplicationDbContext>");
        result.Should().Contain("services.AddScoped<ICustomerRepository, CustomerRepository>();");
    }

    [Fact]
    public async Task GenerateAsync_WithMultipleTables_RegistersAllRepositories()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .WithTable(new Table { Name = "Order" })
            .WithTable(new Table { Name = "Product" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("services.AddScoped<ICustomerRepository, CustomerRepository>();");
        result.Should().Contain("services.AddScoped<IOrderRepository, OrderRepository>();");
        result.Should().Contain("services.AddScoped<IProductRepository, ProductRepository>();");
    }

    [Fact]
    public async Task GenerateAsync_IncludesAutoGeneratedHeader()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("// <auto-generated>");
        result.Should().Contain("// This file was automatically generated by TargCC Core V2");
        result.Should().Contain("// Generation Date:");
    }

    [Fact]
    public async Task GenerateAsync_IncludesRequiredUsings()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("using Microsoft.EntityFrameworkCore;");
        result.Should().Contain("using Microsoft.Extensions.Configuration;");
        result.Should().Contain("using Microsoft.Extensions.DependencyInjection;");
        result.Should().Contain("using TargCC.Domain.Interfaces;");
        result.Should().Contain("using TargCC.Infrastructure.Repositories;");
    }

    [Fact]
    public async Task GenerateAsync_IncludesCorrectNamespace()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("namespace TargCC.Infrastructure.Data;");
    }

    [Fact]
    public async Task GenerateAsync_IncludesDbContextConfiguration()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("services.AddDbContext<ApplicationDbContext>(options =>");
        result.Should().Contain("var connectionString = configuration.GetConnectionString(\"DefaultConnection\")");
        result.Should().Contain("options.UseSqlServer(connectionString);");
    }

    [Fact]
    public async Task GenerateAsync_IncludesConnectionStringValidation()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("?? throw new InvalidOperationException(\"Connection string 'DefaultConnection' not found.\");");
    }

    [Fact]
    public async Task GenerateAsync_IncludesXmlDocumentation()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("/// <summary>");
        result.Should().Contain("/// Extension methods for Infrastructure service registration.");
        result.Should().Contain("/// <param name=\"services\">");
        result.Should().Contain("/// <param name=\"configuration\">");
        result.Should().Contain("/// <returns>");
    }

    [Fact]
    public async Task GenerateAsync_OrdersRepositoriesAlphabetically()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Product" })
            .WithTable(new Table { Name = "Customer" })
            .WithTable(new Table { Name = "Order" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        var customerIndex = result.IndexOf("ICustomerRepository");
        var orderIndex = result.IndexOf("IOrderRepository");
        var productIndex = result.IndexOf("IProductRepository");

        customerIndex.Should().BeLessThan(orderIndex);
        orderIndex.Should().BeLessThan(productIndex);
    }

    [Fact]
    public async Task GenerateAsync_ReturnsServiceCollection()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("return services;");
    }

    [Fact]
    public async Task GenerateAsync_LogsInformationMessages()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .Build();

        // Act
        await _generator.GenerateAsync(schema);

        // Assert
        _loggerMock.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Generating DI registration")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task GenerateAsync_WithEmptySchema_GeneratesMinimalRegistration()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder().Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("public static class InfrastructureServiceRegistration");
        result.Should().Contain("AddDbContext<ApplicationDbContext>");
        result.Should().Contain("return services;");
    }

    [Fact]
    public async Task GenerateAsync_ComplexSchema_GeneratesCompleteRegistration()
    {
        // Arrange
        var schema = new DatabaseSchemaBuilder()
            .WithTable(new Table { Name = "Customer" })
            .WithTable(new Table { Name = "Order" })
            .WithTable(new Table { Name = "OrderItem" })
            .WithTable(new Table { Name = "Product" })
            .WithTable(new Table { Name = "Category" })
            .Build();

        // Act
        var result = await _generator.GenerateAsync(schema);

        // Assert
        result.Should().Contain("services.AddScoped<ICustomerRepository, CustomerRepository>();");
        result.Should().Contain("services.AddScoped<IOrderRepository, OrderRepository>();");
        result.Should().Contain("services.AddScoped<IOrderItemRepository, OrderItemRepository>();");
        result.Should().Contain("services.AddScoped<IProductRepository, ProductRepository>();");
        result.Should().Contain("services.AddScoped<ICategoryRepository, CategoryRepository>();");
    }
}
