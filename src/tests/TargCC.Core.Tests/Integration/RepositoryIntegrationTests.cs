// <auto-generated>
// This code was generated by TargCC Code Generator.
// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>

using System.Diagnostics;
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using TargCC.Core.Generators.Data;
using TargCC.Core.Generators.Repositories;
using TargCC.Core.Tests.TestHelpers;
using Xunit;

namespace TargCC.Core.Tests.Integration;

/// <summary>
/// Integration tests for Repository + DbContext generators working together.
/// </summary>
public class RepositoryIntegrationTests : IntegrationTestBase
{
    private readonly IRepositoryInterfaceGenerator _repositoryInterfaceGenerator;
    private readonly IRepositoryGenerator _repositoryGenerator;
    private readonly IDbContextGenerator _dbContextGenerator;
    private readonly IEntityConfigurationGenerator _entityConfigurationGenerator;

    public RepositoryIntegrationTests()
    {
        // Create typed loggers for each generator
        var repoInterfaceLogger = new Mock<ILogger<RepositoryInterfaceGenerator>>().Object;
        var repoLogger = new Mock<ILogger<RepositoryGenerator>>().Object;
        var dbContextLogger = new Mock<ILogger<DbContextGenerator>>().Object;
        var configLogger = new Mock<ILogger<EntityConfigurationGenerator>>().Object;
        
        // Create generators with typed loggers
        _repositoryInterfaceGenerator = new RepositoryInterfaceGenerator(repoInterfaceLogger);
        _repositoryGenerator = new RepositoryGenerator(repoLogger);
        _dbContextGenerator = new DbContextGenerator(dbContextLogger);
        _entityConfigurationGenerator = new EntityConfigurationGenerator(configLogger);
    }

    [Fact]
    public async Task EndToEnd_SimpleTable_GeneratesAllComponents()
    {
        // Arrange
        var table = CreateTestTable("Customer");
        var schema = SchemaBuilder.WithTable(table).Build();

        // Act - Generate all components
        var repositoryInterface = await _repositoryInterfaceGenerator.GenerateAsync(table);
        var repository = await _repositoryGenerator.GenerateAsync(table);
        var dbContext = await _dbContextGenerator.GenerateAsync(schema);
        var entityConfig = await _entityConfigurationGenerator.GenerateAsync(table);

        // Assert - All components generated
        repositoryInterface.Should().NotBeNullOrWhiteSpace();
        repository.Should().NotBeNullOrWhiteSpace();
        dbContext.Should().NotBeNullOrWhiteSpace();
        entityConfig.Should().NotBeNullOrWhiteSpace();

        // Assert - Repository interface contains expected methods
        repositoryInterface.Should().Contain("interface ICustomerRepository");
        repositoryInterface.Should().Contain("GetByIdAsync");
        repositoryInterface.Should().Contain("GetAllAsync");
        repositoryInterface.Should().Contain("AddAsync");
        repositoryInterface.Should().Contain("UpdateAsync");
        repositoryInterface.Should().Contain("DeleteAsync");

        // Assert - Repository implements interface
        repository.Should().Contain("class CustomerRepository : ICustomerRepository");
        repository.Should().Contain("QueryFirstOrDefaultAsync<Customer>");
        repository.Should().Contain("SP_GetCustomerByID");
        repository.Should().Contain("ExecuteAsync");

        // Assert - DbContext has DbSet
        dbContext.Should().Contain("DbSet<Customer> Customers");
        dbContext.Should().Contain("ApplyConfigurationsFromAssembly");

        // Assert - Entity configuration exists
        entityConfig.Should().Contain("class CustomerConfiguration : IEntityTypeConfiguration<Customer>");
        entityConfig.Should().Contain("builder.ToTable(\"Customer\")");
        entityConfig.Should().Contain("builder.HasKey(e => e.ID)");
    }

    [Fact]
    public async Task EndToEnd_TableWithAggregates_GeneratesSpecialMethods()
    {
        // Arrange
        var table = CreateTableWithAggregates("Customer");

        // Act
        var repositoryInterface = await _repositoryInterfaceGenerator.GenerateAsync(table);
        var repository = await _repositoryGenerator.GenerateAsync(table);

        // Assert - Special aggregate methods generated
        repositoryInterface.Should().Contain("UpdateAggregatesAsync");
        repositoryInterface.Should().Contain("int orderCount");
        repositoryInterface.Should().Contain("decimal totalSpent");

        repository.Should().Contain("SP_UpdateCustomerAggregates");
        // The generator strips the agg_ prefix from parameter names
        repository.Should().Contain("OrderCount = orderCount");
        repository.Should().Contain("TotalSpent = totalSpent");
    }

    [Fact]
    public async Task EndToEnd_TableWithSpecialColumns_HandlesCorrectly()
    {
        // Arrange
        var table = CreateTableWithSpecialColumns("User");

        // Act
        var entityConfig = await _entityConfigurationGenerator.GenerateAsync(table);

        // Assert - Special columns configured
        entityConfig.Should().Contain("PasswordHashed");
        entityConfig.Should().Contain("HasColumnName(\"eno_Password\")");
        entityConfig.Should().Contain("CreditCard");
        entityConfig.Should().Contain("HasColumnName(\"ent_CreditCard\")");
        entityConfig.Should().Contain("StatusCode");
        entityConfig.Should().Contain("HasColumnName(\"lkp_Status\")");
    }

    [Fact]
    public async Task EndToEnd_MultipleRelatedTables_GeneratesCorrectly()
    {
        // Arrange
        var schema = CreateTestSchema();

        // Act
        var dbContext = await _dbContextGenerator.GenerateAsync(schema);

        // Assert - All tables in DbContext
        dbContext.Should().Contain("DbSet<Customer> Customers");
        dbContext.Should().Contain("DbSet<Order> Orders");

        // Generate configurations
        var customerConfig = await _entityConfigurationGenerator.GenerateAsync(
            schema.Tables.First(t => t.Name == "Customer"));
        var orderConfig = await _entityConfigurationGenerator.GenerateAsync(
            schema.Tables.First(t => t.Name == "Order"));

        // Assert - Relationship configured
        orderConfig.Should().Contain("HasOne");
        orderConfig.Should().Contain("WithMany");
        orderConfig.Should().Contain("HasForeignKey");
        orderConfig.Should().Contain("CustomerID");
    }

    [Fact]
    public async Task EndToEnd_ComplexScenario_AllComponentsWorkTogether()
    {
        // Arrange - Complex schema
        var customerTable = new TableBuilder().WithName("Customer")
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("Name", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("Email", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("eno_Password", "VARCHAR", maxLength: 64, isNullable: false)
            .WithColumn("agg_OrderCount", "INT", isNullable: false)
            .WithColumn("agg_TotalSpent", "DECIMAL", precision: 18, scale: 2)
            .WithIndex("IX_Customer_Email", isUnique: true, columns: new[] { "Email" })
            .Build();

        var schema = SchemaBuilder.WithTable(customerTable).Build();

        // Act - Generate everything
        var repositoryInterface = await _repositoryInterfaceGenerator.GenerateAsync(customerTable);
        var repository = await _repositoryGenerator.GenerateAsync(customerTable);
        var dbContext = await _dbContextGenerator.GenerateAsync(schema);
        var entityConfig = await _entityConfigurationGenerator.GenerateAsync(customerTable);

        // Assert - Repository has all methods
        repositoryInterface.Should().Contain("GetByIdAsync");
        repositoryInterface.Should().Contain("GetByEmailAsync"); // From unique index
        repositoryInterface.Should().Contain("UpdateAggregatesAsync"); // From agg_ columns

        // Assert - Repository implementation correct
        repository.Should().Contain("SP_GetCustomerByID");
        repository.Should().Contain("SP_GetCustomerByEmail");
        repository.Should().Contain("SP_UpdateCustomerAggregates");

        // Assert - DbContext configured
        dbContext.Should().Contain("DbSet<Customer> Customers");

        // Assert - Entity configuration handles special columns
        entityConfig.Should().Contain("PasswordHashed");
        entityConfig.Should().Contain("OrderCount");
        entityConfig.Should().Contain("TotalSpent");
        entityConfig.Should().Contain("IsUnique");
    }

    [Fact]
    public async Task Performance_GenerateAllComponents_CompletesQuickly()
    {
        // Arrange
        var table = CreateTestTable("Customer");
        var schema = SchemaBuilder.WithTable(table).Build();
        var stopwatch = new Stopwatch();

        // Act
        stopwatch.Start();
        
        await _repositoryInterfaceGenerator.GenerateAsync(table);
        await _repositoryGenerator.GenerateAsync(table);
        await _dbContextGenerator.GenerateAsync(schema);
        await _entityConfigurationGenerator.GenerateAsync(table);
        
        stopwatch.Stop();

        // Assert - Should complete in less than 1 second
        stopwatch.ElapsedMilliseconds.Should().BeLessThan(1000,
            "All generators should complete in under 1 second for a simple table");
    }

    [Fact]
    public async Task Performance_LargeSchema_GeneratesEfficiently()
    {
        // Arrange - Create schema with 10 tables
        var builder = new DatabaseSchemaBuilder();
        
        for (int i = 1; i <= 10; i++)
        {
            var table = new TableBuilder().WithName($"Table{i}")
                .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
                .WithColumn($"Name{i}", "NVARCHAR", maxLength: 100, isNullable: false)
                .WithColumn($"Value{i}", "INT", isNullable: false)
                .Build();
            
            builder.WithTable(table);
        }
        
        var schema = builder.Build();
        var stopwatch = new Stopwatch();

        // Act
        stopwatch.Start();
        
        var dbContext = await _dbContextGenerator.GenerateAsync(schema);
        
        foreach (var table in schema.Tables)
        {
            await _repositoryInterfaceGenerator.GenerateAsync(table);
            await _repositoryGenerator.GenerateAsync(table);
            await _entityConfigurationGenerator.GenerateAsync(table);
        }
        
        stopwatch.Stop();

        // Assert - Should complete in less than 5 seconds
        stopwatch.ElapsedMilliseconds.Should().BeLessThan(5000,
            "All generators should complete in under 5 seconds for 10 tables");

        // Assert - DbContext has all tables (lowercase 's' for plural)
        dbContext.Should().Contain("DbSet<Table1> Table1s");
        dbContext.Should().Contain("DbSet<Table10> Table10s");
    }

    [Fact]
    public async Task CodeQuality_GeneratedCode_CompilesWithoutErrors()
    {
        // Arrange
        var table = CreateTestTable("Customer");
        var schema = SchemaBuilder.WithTable(table).Build();

        // Act
        var repositoryInterface = await _repositoryInterfaceGenerator.GenerateAsync(table);
        var repository = await _repositoryGenerator.GenerateAsync(table);
        var dbContext = await _dbContextGenerator.GenerateAsync(schema);
        var entityConfig = await _entityConfigurationGenerator.GenerateAsync(table);

        // Assert - All code includes necessary using statements
        // Note: Modern C# projects use implicit usings, so System namespace is not explicitly imported
        repositoryInterface.Should().Contain("using TargCC.Domain.Entities;");
        repository.Should().Contain("using Dapper;");
        dbContext.Should().Contain("using Microsoft.EntityFrameworkCore;");
        entityConfig.Should().Contain("using Microsoft.EntityFrameworkCore.Metadata.Builders;");

        // Assert - All code has proper namespaces
        repositoryInterface.Should().Contain("namespace");
        repository.Should().Contain("namespace");
        dbContext.Should().Contain("namespace");
        entityConfig.Should().Contain("namespace");

        // Assert - All code has XML documentation
        repositoryInterface.Should().Contain("/// <summary>");
        repository.Should().Contain("/// <summary>");
        dbContext.Should().Contain("/// <summary>");
        entityConfig.Should().Contain("/// <summary>");
    }
}
