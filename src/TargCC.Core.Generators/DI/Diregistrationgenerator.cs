// <auto-generated>
// This file is part of TargCC Core V2
// Generated by: TargCC.Core.Generators
// Generation Date: 2025-11-20
// </auto-generated>

#nullable enable

using System.Globalization;
using System.Text;
using Microsoft.Extensions.Logging;
using TargCC.Core.Interfaces.Models;
//using TargCC.Core.Models;

namespace TargCC.Core.Generators.DI;

/// <summary>
/// Generator for Dependency Injection registration code.
/// Creates InfrastructureServiceRegistration extension class for service configuration.
/// </summary>
public class DIRegistrationGenerator : IDIRegistrationGenerator
{
    private readonly ILogger<DIRegistrationGenerator> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="DIRegistrationGenerator"/> class.
    /// </summary>
    /// <param name="logger">Logger instance for diagnostic output.</param>
    /// <exception cref="ArgumentNullException">Thrown when logger is null.</exception>
    public DIRegistrationGenerator(ILogger<DIRegistrationGenerator> logger)
    {
        ArgumentNullException.ThrowIfNull(logger);
        _logger = logger;
    }

    /// <inheritdoc/>
    public async Task<string> GenerateAsync(DatabaseSchema schema, CancellationToken cancellationToken = default)
    {
        ArgumentNullException.ThrowIfNull(schema);

        LogGeneratingDIRegistration(_logger, schema.Tables.Count, null);

        await Task.CompletedTask; // For async pattern consistency

        var sb = new StringBuilder();

        // File header
        GenerateFileHeader(sb);

        // Usings
        GenerateUsings(sb);

        // Namespace
        sb.AppendLine("namespace TargCC.Infrastructure.Data;");
        sb.AppendLine();

        // Class start
        sb.AppendLine("/// <summary>");
        sb.AppendLine("/// Extension methods for Infrastructure service registration.");
        sb.AppendLine("/// Configures DbContext, repositories, and other infrastructure services.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine("public static class InfrastructureServiceRegistration");
        sb.AppendLine("{");

        // AddInfrastructure method
        GenerateAddInfrastructureMethod(sb, schema);

        // Class end
        sb.AppendLine("}");

        LogSuccessfullyGeneratedDIRegistration(_logger, null);

        return sb.ToString();
    }

    private static void GenerateFileHeader(StringBuilder sb)
    {
        sb.AppendLine("// <auto-generated>");
        sb.AppendLine("// This file was automatically generated by TargCC Core V2");
        sb.AppendLine(CultureInfo.InvariantCulture, $"// Generation Date: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        sb.AppendLine("//");
        sb.AppendLine("// Changes to this file may cause incorrect behavior and will be lost");
        sb.AppendLine("// if the code is regenerated.");
        sb.AppendLine("// </auto-generated>");
        sb.AppendLine();
    }

    private static void GenerateUsings(StringBuilder sb)
    {
        sb.AppendLine("using Microsoft.EntityFrameworkCore;");
        sb.AppendLine("using Microsoft.Extensions.Configuration;");
        sb.AppendLine("using Microsoft.Extensions.DependencyInjection;");
        sb.AppendLine("using TargCC.Domain.Interfaces;");
        sb.AppendLine("using TargCC.Infrastructure.Repositories;");
        sb.AppendLine();
    }

    private static void GenerateAddInfrastructureMethod(StringBuilder sb, DatabaseSchema schema)
    {
        sb.AppendLine("    /// <summary>");
        sb.AppendLine("    /// Adds Infrastructure services to the dependency injection container.");
        sb.AppendLine("    /// Configures DbContext with SQL Server and registers all repositories.");
        sb.AppendLine("    /// </summary>");
        sb.AppendLine("    /// <param name=\"services\">Service collection to add services to.</param>");
        sb.AppendLine("    /// <param name=\"configuration\">Configuration containing connection strings.</param>");
        sb.AppendLine("    /// <returns>The service collection for method chaining.</returns>");
        sb.AppendLine("    public static IServiceCollection AddInfrastructure(");
        sb.AppendLine("        this IServiceCollection services,");
        sb.AppendLine("        IConfiguration configuration)");
        sb.AppendLine("    {");

        // DbContext registration
        sb.AppendLine("        // Register DbContext");
        sb.AppendLine("        services.AddDbContext<ApplicationDbContext>(options =>");
        sb.AppendLine("        {");
        sb.AppendLine("            var connectionString = configuration.GetConnectionString(\"DefaultConnection\")");
        sb.AppendLine("                ?? throw new InvalidOperationException(\"Connection string 'DefaultConnection' not found.\");");
        sb.AppendLine();
        sb.AppendLine("            options.UseSqlServer(connectionString);");
        sb.AppendLine("        });");
        sb.AppendLine();

        // Repository registrations
        sb.AppendLine("        // Register repositories");
        foreach (var table in schema.Tables.OrderBy(t => t.Name))
        {
            var repositoryInterface = $"I{table.Name}Repository";
            var repositoryClass = $"{table.Name}Repository";

            sb.AppendLine(CultureInfo.InvariantCulture, $"        services.AddScoped<{repositoryInterface}, {repositoryClass}>();");
        }

        sb.AppendLine();
        sb.AppendLine("        return services;");
        sb.AppendLine("    }");
    }

    #region Logging

    private static readonly Action<ILogger, int, Exception?> LogGeneratingDIRegistration =
        LoggerMessage.Define<int>(
            LogLevel.Information,
            new EventId(1, nameof(GenerateAsync)),
            "Generating DI registration for {TableCount} tables");

    private static readonly Action<ILogger, Exception?> LogSuccessfullyGeneratedDIRegistration =
        LoggerMessage.Define(
            LogLevel.Information,
            new EventId(2, nameof(GenerateAsync)),
            "Successfully generated DI registration");

    #endregion
}
