// <copyright file="DashboardControllerGenerator.cs" company="PlaceholderCompany">
// Copyright (c) PlaceholderCompany. All rights reserved.
// </copyright>

namespace TargCC.Core.Generators.API
{
    using System;
    using System.Collections.Generic;
    using System.Globalization;
    using System.Linq;
    using System.Text;
    using TargCC.Core.Interfaces.Models;

    /// <summary>
    /// Generates ASP.NET Core Dashboard API Controller with statistics and activity endpoints.
    /// </summary>
    public static class DashboardControllerGenerator
    {
        /// <summary>
        /// Generates the Dashboard controller code.
        /// </summary>
        /// <param name="tables">List of tables in the database schema.</param>
        /// <param name="rootNamespace">Root namespace for the project.</param>
        /// <returns>Generated C# code for Dashboard controller.</returns>
        public static string Generate(IList<Table> tables, string rootNamespace)
        {
            var tableTables = tables.Where(t => !t.IsView).Take(3).ToList();
            var sb = new StringBuilder();

            // File header
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("//     This code was generated by TargCC Dashboard Controller Generator.");
            sb.AppendLine(CultureInfo.InvariantCulture, $"//     Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine("//     Changes to this file may cause incorrect behavior and will be lost if");
            sb.AppendLine("//     the code is regenerated.");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();

            // Usings
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine("using System.Linq;");
            sb.AppendLine("using System.Threading.Tasks;");
            sb.AppendLine("using Microsoft.AspNetCore.Mvc;");
            sb.AppendLine("using Microsoft.Extensions.Logging;");
            sb.AppendLine(CultureInfo.InvariantCulture, $"using {rootNamespace}.Domain.Interfaces;");
            sb.AppendLine();

            sb.AppendLine(CultureInfo.InvariantCulture, $"namespace {rootNamespace}.API.Controllers");
            sb.AppendLine("{");

            GenerateDTOs(sb, tableTables);
            sb.AppendLine();

            GenerateControllerClass(sb, tableTables);

            sb.AppendLine("}");

            return sb.ToString();
        }

        private static void GenerateDTOs(StringBuilder sb, IList<Table> tables)
        {
            // DashboardStatsDto
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Dashboard statistics DTO.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public class DashboardStatsDto");
            sb.AppendLine("    {");

            foreach (var table in tables)
            {
                var className = GetClassName(table.Name);
                var camelName = char.ToLowerInvariant(className[0]) + className.Substring(1);

                sb.AppendLine(CultureInfo.InvariantCulture, $"        public int Total{className}s {{ get; set; }}");
                sb.AppendLine(CultureInfo.InvariantCulture, $"        public decimal {camelName}sGrowth {{ get; set; }}");
            }

            sb.AppendLine("    }");
            sb.AppendLine();

            // ActivityDto
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Recent activity DTO.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public class ActivityDto");
            sb.AppendLine("    {");
            sb.AppendLine("        public int Id { get; set; }");
            sb.AppendLine("        public string Title { get; set; } = string.Empty;");
            sb.AppendLine("        public string Time { get; set; } = string.Empty;");
            sb.AppendLine("        public string Icon { get; set; } = string.Empty;");
            sb.AppendLine("    }");
        }

        private static void GenerateControllerClass(StringBuilder sb, IList<Table> tables)
        {
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Dashboard API controller providing statistics and recent activity.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    [ApiController]");
            sb.AppendLine("    [Route(\"api/[controller]\")]");
            sb.AppendLine("    [Produces(\"application/json\")]");
            sb.AppendLine("    public class DashboardController : ControllerBase");
            sb.AppendLine("    {");

            GenerateFields(sb, tables);
            sb.AppendLine();

            GenerateConstructor(sb, tables);
            sb.AppendLine();

            GenerateStatsEndpoint(sb, tables);
            sb.AppendLine();

            GenerateRecentActivityEndpoint(sb);

            sb.AppendLine("    }");
        }

        private static void GenerateFields(StringBuilder sb, IList<Table> tables)
        {
            foreach (var table in tables)
            {
                var className = GetClassName(table.Name);
                sb.AppendLine(CultureInfo.InvariantCulture, $"        private readonly I{className}Repository _{char.ToLowerInvariant(className[0]) + className.Substring(1)}Repository;");
            }

            sb.AppendLine("        private readonly ILogger<DashboardController> _logger;");
        }

        private static void GenerateConstructor(StringBuilder sb, IList<Table> tables)
        {
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// Initializes a new instance of the <see cref=\"DashboardController\"/> class.");
            sb.AppendLine("        /// </summary>");

            foreach (var table in tables)
            {
                var className = GetClassName(table.Name);
                var camelName = char.ToLowerInvariant(className[0]) + className.Substring(1);
                sb.AppendLine(CultureInfo.InvariantCulture, $"        /// <param name=\"{camelName}Repository\">Repository for {className}.</param>");
            }

            sb.AppendLine("        /// <param name=\"logger\">Logger instance.</param>");
            sb.AppendLine("        public DashboardController(");

            var repoParams = string.Join(",\n", tables.Select(t =>
            {
                var className = GetClassName(t.Name);
                var camelName = char.ToLowerInvariant(className[0]) + className.Substring(1);
                return $"            I{className}Repository {camelName}Repository";
            }));

            sb.AppendLine(repoParams + ",");
            sb.AppendLine("            ILogger<DashboardController> logger)");
            sb.AppendLine("        {");

            foreach (var table in tables)
            {
                var className = GetClassName(table.Name);
                var camelName = char.ToLowerInvariant(className[0]) + className.Substring(1);
                sb.AppendLine(CultureInfo.InvariantCulture, $"            _{camelName}Repository = {camelName}Repository ?? throw new ArgumentNullException(nameof({camelName}Repository));");
            }

            sb.AppendLine("            _logger = logger ?? throw new ArgumentNullException(nameof(logger));");
            sb.AppendLine("        }");
        }

        private static void GenerateStatsEndpoint(StringBuilder sb, IList<Table> tables)
        {
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// Gets dashboard statistics including entity counts and growth metrics.");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <returns>Dashboard statistics.</returns>");
            sb.AppendLine("        [HttpGet(\"stats\")]");
            sb.AppendLine("        [ProducesResponseType(typeof(DashboardStatsDto), 200)]");
            sb.AppendLine("        public async Task<ActionResult<DashboardStatsDto>> GetStats()");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine("                var stats = new DashboardStatsDto");
            sb.AppendLine("                {");

            var statsProperties = string.Join(",\n", tables.Select(t =>
            {
                var className = GetClassName(t.Name);
                var camelName = char.ToLowerInvariant(className[0]) + className.Substring(1);
                return $"                    Total{className}s = (await _{camelName}Repository.GetAllAsync().ConfigureAwait(false)).Count(),\n" +
                       $"                    {camelName}sGrowth = CalculateGrowth(new Random().Next(1, 20))";
            }));

            sb.AppendLine(statsProperties);
            sb.AppendLine("                };");
            sb.AppendLine();
            sb.AppendLine("                return Ok(stats);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _logger.LogError(ex, \"Error fetching dashboard statistics\");");
            sb.AppendLine("                return StatusCode(500, \"An error occurred while fetching statistics\");");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
        }

        private static void GenerateRecentActivityEndpoint(StringBuilder sb)
        {
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// Gets recent activity events.");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        /// <returns>Collection of recent activities.</returns>");
            sb.AppendLine("        [HttpGet(\"recent-activity\")]");
            sb.AppendLine("        [ProducesResponseType(typeof(IEnumerable<ActivityDto>), 200)]");
            sb.AppendLine("        public ActionResult<IEnumerable<ActivityDto>> GetRecentActivity()");
            sb.AppendLine("        {");
            sb.AppendLine("            try");
            sb.AppendLine("            {");
            sb.AppendLine("                // Sample activity data - in production, this would query an audit log or activity table");
            sb.AppendLine("                var activities = new List<ActivityDto>");
            sb.AppendLine("                {");
            sb.AppendLine("                    new ActivityDto { Id = 1, Title = \"New record created\", Time = \"5 minutes ago\", Icon = \"✓\" },");
            sb.AppendLine("                    new ActivityDto { Id = 2, Title = \"Record updated\", Time = \"15 minutes ago\", Icon = \"✎\" },");
            sb.AppendLine("                    new ActivityDto { Id = 3, Title = \"Record deleted\", Time = \"1 hour ago\", Icon = \"✗\" },");
            sb.AppendLine("                    new ActivityDto { Id = 4, Title = \"Bulk import completed\", Time = \"2 hours ago\", Icon = \"↓\" },");
            sb.AppendLine("                    new ActivityDto { Id = 5, Title = \"System backup completed\", Time = \"3 hours ago\", Icon = \"◉\" }");
            sb.AppendLine("                };");
            sb.AppendLine();
            sb.AppendLine("                return Ok(activities);");
            sb.AppendLine("            }");
            sb.AppendLine("            catch (Exception ex)");
            sb.AppendLine("            {");
            sb.AppendLine("                _logger.LogError(ex, \"Error fetching recent activity\");");
            sb.AppendLine("                return StatusCode(500, \"An error occurred while fetching activity\");");
            sb.AppendLine("            }");
            sb.AppendLine("        }");
            sb.AppendLine();
            sb.AppendLine("        /// <summary>");
            sb.AppendLine("        /// Calculates a growth percentage (placeholder logic).");
            sb.AppendLine("        /// </summary>");
            sb.AppendLine("        private static decimal CalculateGrowth(int value)");
            sb.AppendLine("        {");
            sb.AppendLine("            // In production, compare current period vs previous period");
            sb.AppendLine("            return Math.Round((decimal)value * 0.5m, 1);");
            sb.AppendLine("        }");
        }

        private static string GetClassName(string tableName)
        {
            if (string.IsNullOrEmpty(tableName))
            {
                return tableName;
            }

            // Remove schema prefix (e.g., "dbo." from "dbo.Customer")
            var name = tableName;
            if (tableName.Contains('.', StringComparison.Ordinal))
            {
                var parts = tableName.Split('.');
                name = parts[^1];
            }

            // Remove any prefix before underscore (e.g., "tbl_" from "tbl_Customer")
            if (name.Contains('_', StringComparison.Ordinal))
            {
                var parts = name.Split('_');
                name = parts[^1];
            }

            // Convert to PascalCase
            return char.ToUpperInvariant(name[0]) + name.Substring(1);
        }
    }
}
