namespace TargCC.Core.Generators.API
{
    using System;
    using System.Globalization;
    using System.Text;
    using Microsoft.Extensions.Logging;

    /// <summary>
    /// Generates API controller for c_Enumeration table access.
    /// </summary>
    public static class EnumerationControllerGenerator
    {
        /// <summary>
        /// Generates the EnumerationsController code.
        /// </summary>
        /// <param name="rootNamespace">Root namespace for the project.</param>
        /// <returns>C# code for the controller.</returns>
        public static string Generate(string rootNamespace)
        {
            var sb = new StringBuilder();

            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("//     This code was generated by TargCC");
            sb.AppendLine("//     Enumeration API Controller");
            sb.AppendLine(CultureInfo.InvariantCulture, $"//     Generation date: {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            sb.AppendLine("using Microsoft.AspNetCore.Mvc;");
            sb.AppendLine("using Microsoft.Data.SqlClient;");
            sb.AppendLine("using Microsoft.Extensions.Configuration;");
            sb.AppendLine("using Microsoft.Extensions.Logging;");
            sb.AppendLine("using Dapper;");
            sb.AppendLine();
            sb.AppendLine(CultureInfo.InvariantCulture, $"namespace {rootNamespace}.API.Controllers;");
            sb.AppendLine();
            sb.AppendLine("/// <summary>");
            sb.AppendLine("/// API controller for accessing enum values from c_Enumeration table.");
            sb.AppendLine("/// </summary>");
            sb.AppendLine("[ApiController]");
            sb.AppendLine("[Route(\"api/[controller]\")]");
            sb.AppendLine("public class EnumerationsController : ControllerBase");
            sb.AppendLine("{");
            sb.AppendLine("    private readonly IConfiguration _configuration;");
            sb.AppendLine("    private readonly ILogger<EnumerationsController> _logger;");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Initializes a new instance of the <see cref=\"EnumerationsController\"/> class.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public EnumerationsController(");
            sb.AppendLine("        IConfiguration configuration,");
            sb.AppendLine("        ILogger<EnumerationsController> logger)");
            sb.AppendLine("    {");
            sb.AppendLine("        _configuration = configuration;");
            sb.AppendLine("        _logger = logger;");
            sb.AppendLine("    }");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets all enum values for a specific enum type.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    /// <param name=\"enumType\">The enum type to retrieve.</param>");
            sb.AppendLine("    /// <returns>List of enum values.</returns>");
            sb.AppendLine("    [HttpGet(\"{enumType}\")]");
            sb.AppendLine("    public async Task<ActionResult<IEnumerable<EnumValueDto>>> GetEnumValues(string enumType)");
            sb.AppendLine("    {");
            sb.AppendLine("        try");
            sb.AppendLine("        {");
            sb.AppendLine("            var connectionString = _configuration.GetConnectionString(\"DefaultConnection\");");
            sb.AppendLine("            using var connection = new SqlConnection(connectionString);");
            sb.AppendLine();
            sb.AppendLine("            var sql = @\"");
            sb.AppendLine("                SELECT");
            sb.AppendLine("                    EnumType,");
            sb.AppendLine("                    EnumValue,");
            sb.AppendLine("                    locText,");
            sb.AppendLine("                    locDescription,");
            sb.AppendLine("                    ISNULL(OrdinalPosition, 0) AS OrdinalPosition");
            sb.AppendLine("                FROM dbo.c_Enumeration");
            sb.AppendLine("                WHERE EnumType = @EnumType");
            sb.AppendLine("                  AND DeletedOn IS NULL");
            sb.AppendLine("                ORDER BY ISNULL(OrdinalPosition, 0), EnumValue\";");
            sb.AppendLine();
            sb.AppendLine("            var enums = await connection.QueryAsync<EnumValueDto>(sql, new { EnumType = enumType });");
            sb.AppendLine("            return Ok(enums);");
            sb.AppendLine("        }");
            sb.AppendLine("        catch (Exception ex)");
            sb.AppendLine("        {");
            sb.AppendLine("            _logger.LogError(ex, \"Failed to load enum values for type {EnumType}\", enumType);");
            sb.AppendLine("            return StatusCode(500, \"Failed to load enum values\");");
            sb.AppendLine("        }");
            sb.AppendLine("    }");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets all available enum types.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    /// <returns>List of enum type names.</returns>");
            sb.AppendLine("    [HttpGet(\"types\")]");
            sb.AppendLine("    public async Task<ActionResult<IEnumerable<string>>> GetEnumTypes()");
            sb.AppendLine("    {");
            sb.AppendLine("        try");
            sb.AppendLine("        {");
            sb.AppendLine("            var connectionString = _configuration.GetConnectionString(\"DefaultConnection\");");
            sb.AppendLine("            using var connection = new SqlConnection(connectionString);");
            sb.AppendLine();
            sb.AppendLine("            var sql = @\"");
            sb.AppendLine("                SELECT DISTINCT EnumType");
            sb.AppendLine("                FROM dbo.c_Enumeration");
            sb.AppendLine("                WHERE DeletedOn IS NULL");
            sb.AppendLine("                ORDER BY EnumType\";");
            sb.AppendLine();
            sb.AppendLine("            var enumTypes = await connection.QueryAsync<string>(sql);");
            sb.AppendLine("            return Ok(enumTypes);");
            sb.AppendLine("        }");
            sb.AppendLine("        catch (Exception ex)");
            sb.AppendLine("        {");
            sb.AppendLine("            _logger.LogError(ex, \"Failed to load enum types\");");
            sb.AppendLine("            return StatusCode(500, \"Failed to load enum types\");");
            sb.AppendLine("        }");
            sb.AppendLine("    }");
            sb.AppendLine("}");
            sb.AppendLine();
            sb.AppendLine("/// <summary>");
            sb.AppendLine("/// DTO for enum values.");
            sb.AppendLine("/// </summary>");
            sb.AppendLine("public class EnumValueDto");
            sb.AppendLine("{");
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets or sets the enum type.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public string EnumType { get; set; } = string.Empty;");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets or sets the enum value.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public string EnumValue { get; set; } = string.Empty;");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets or sets the localized text.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public string? LocText { get; set; }");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets or sets the localized description.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public string? LocDescription { get; set; }");
            sb.AppendLine();
            sb.AppendLine("    /// <summary>");
            sb.AppendLine("    /// Gets or sets the ordinal position for sorting.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine("    public int OrdinalPosition { get; set; }");
            sb.AppendLine("}");

            return sb.ToString();
        }
    }
}
