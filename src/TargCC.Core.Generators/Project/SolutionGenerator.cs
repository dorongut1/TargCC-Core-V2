// ------------------------------------------------------------------------------
// <auto-generated>
//     This file is part of TargCC.Core.Generators
//     Copyright (c) 2024-2025 TargCC. All rights reserved.
// </auto-generated>
// ------------------------------------------------------------------------------

#nullable enable

using System.Text;
using Microsoft.Extensions.Logging;
using TargCC.Core.Generators.Project.Models;

namespace TargCC.Core.Generators.Project;

/// <summary>
/// Generates Visual Studio solution files (.sln).
/// </summary>
public class SolutionGenerator : ISolutionGenerator
{
    private readonly ILogger<SolutionGenerator> _logger;

    // Visual Studio project type GUIDs
    private static readonly Guid CSharpProjectTypeGuid = new("FAE04EC0-301F-11D3-BF4B-00C04F79EFBC");

    /// <summary>
    /// Initializes a new instance of the <see cref="SolutionGenerator"/> class.
    /// </summary>
    /// <param name="logger">Logger instance.</param>
    public SolutionGenerator(ILogger<SolutionGenerator> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public string Generate(SolutionInfo solutionInfo)
    {
        ArgumentNullException.ThrowIfNull(solutionInfo);

        _logger.LogInformation("Generating solution file: {SolutionName}", solutionInfo.Name);

        var sb = new StringBuilder();

        // Header
        sb.AppendLine();
        sb.AppendLine("Microsoft Visual Studio Solution File, Format Version 12.00");
        sb.AppendLine("# Visual Studio Version 17");
        sb.AppendLine("VisualStudioVersion = 17.0.31903.59");
        sb.AppendLine("MinimumVisualStudioVersion = 10.0.40219.1");

        // Solution folders
        foreach (var folder in solutionInfo.Folders)
        {
            sb.AppendLine($"Project(\"{{{SolutionFolder.SolutionFolderTypeGuid.ToString().ToUpperInvariant()}}}\") = \"{folder.Name}\", \"{folder.Name}\", \"{{{folder.FolderGuid.ToString().ToUpperInvariant()}}}\"");
            sb.AppendLine("EndProject");
        }

        // Projects
        foreach (var project in solutionInfo.Projects)
        {
            var projectTypeGuid = CSharpProjectTypeGuid.ToString().ToUpperInvariant();
            var projectGuid = project.ProjectGuid.ToString().ToUpperInvariant();
            var relativePath = project.CsprojPath.Replace('/', '\\');

            sb.AppendLine($"Project(\"{{{projectTypeGuid}}}\") = \"{project.Name}\", \"{relativePath}\", \"{{{projectGuid}}}\"");
            sb.AppendLine("EndProject");
        }

        // Global section
        sb.AppendLine("Global");

        // Solution configuration platforms
        sb.AppendLine("\tGlobalSection(SolutionConfigurationPlatforms) = preSolution");
        sb.AppendLine("\t\tDebug|Any CPU = Debug|Any CPU");
        sb.AppendLine("\t\tRelease|Any CPU = Release|Any CPU");
        sb.AppendLine("\tEndGlobalSection");

        // Project configuration platforms
        sb.AppendLine("\tGlobalSection(ProjectConfigurationPlatforms) = postSolution");
        foreach (var project in solutionInfo.Projects)
        {
            var projectGuid = project.ProjectGuid.ToString().ToUpperInvariant();
            sb.AppendLine($"\t\t{{{projectGuid}}}.Debug|Any CPU.ActiveCfg = Debug|Any CPU");
            sb.AppendLine($"\t\t{{{projectGuid}}}.Debug|Any CPU.Build.0 = Debug|Any CPU");
            sb.AppendLine($"\t\t{{{projectGuid}}}.Release|Any CPU.ActiveCfg = Release|Any CPU");
            sb.AppendLine($"\t\t{{{projectGuid}}}.Release|Any CPU.Build.0 = Release|Any CPU");
        }
        sb.AppendLine("\tEndGlobalSection");

        // Nested projects (folder hierarchy)
        if (solutionInfo.Folders.Any(f => f.ProjectGuids.Any()))
        {
            sb.AppendLine("\tGlobalSection(NestedProjects) = preSolution");
            foreach (var folder in solutionInfo.Folders)
            {
                foreach (var projectGuid in folder.ProjectGuids)
                {
                    sb.AppendLine($"\t\t{{{projectGuid.ToString().ToUpperInvariant()}}} = {{{folder.FolderGuid.ToString().ToUpperInvariant()}}}");
                }
            }
            sb.AppendLine("\tEndGlobalSection");
        }

        // Solution properties
        sb.AppendLine("\tGlobalSection(SolutionProperties) = preSolution");
        sb.AppendLine("\t\tHideSolutionNode = FALSE");
        sb.AppendLine("\tEndGlobalSection");

        sb.AppendLine("EndGlobal");

        _logger.LogInformation("Solution file generated with {ProjectCount} projects", solutionInfo.Projects.Count);

        return sb.ToString();
    }

    /// <inheritdoc/>
    public async Task<string> GenerateAndSaveAsync(SolutionInfo solutionInfo)
    {
        ArgumentNullException.ThrowIfNull(solutionInfo);

        var content = Generate(solutionInfo);
        var filePath = solutionInfo.SlnPath;

        // Ensure directory exists
        var directory = Path.GetDirectoryName(filePath);
        if (!string.IsNullOrEmpty(directory))
        {
            Directory.CreateDirectory(directory);
        }

        await File.WriteAllTextAsync(filePath, content);
        _logger.LogInformation("Solution file saved to: {FilePath}", filePath);

        return filePath;
    }
}
