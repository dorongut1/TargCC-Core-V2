namespace TargCC.Core.Generators.Repositories;

using TargCC.Core.Interfaces.Models;

/// <summary>
/// Interface for generating repository implementation code from database table metadata.
/// </summary>
/// <remarks>
/// <para>
/// The RepositoryGenerator creates concrete repository classes that implement the repository
/// interfaces generated by <see cref="IRepositoryInterfaceGenerator"/>. These implementations
/// use Dapper for stored procedure calls and provide complete data access functionality.
/// </para>
/// <para>
/// <strong>Generated Implementation Structure:</strong>
/// </para>
/// <list type="bullet">
/// <item><term>Constructor</term><description>Dependency injection for IDbConnection and ILogger</description></item>
/// <item><term>CRUD Methods</term><description>Full implementation using Dapper + Stored Procedures</description></item>
/// <item><term>Query Methods</term><description>Index-based queries with proper parameter mapping</description></item>
/// <item><term>Error Handling</term><description>Try-catch blocks with logging and proper exception propagation</description></item>
/// <item><term>Connection Management</term><description>Proper connection lifecycle management</description></item>
/// </list>
/// <para>
/// <strong>Technology Stack:</strong>
/// </para>
/// <list type="bullet">
/// <item><term>Dapper</term><description>For stored procedure calls and object mapping</description></item>
/// <item><term>Microsoft.Data.SqlClient</term><description>For SQL Server connectivity</description></item>
/// <item><term>ILogger</term><description>For structured logging</description></item>
/// <item><term>CancellationToken</term><description>For async cancellation support</description></item>
/// </list>
/// </remarks>
/// <example>
/// <para><strong>Example: Generate repository implementation</strong></para>
/// <code>
/// var generator = new RepositoryGenerator(logger);
/// var customerTable = new Table
/// {
///     Name = "Customer",
///     PrimaryKeyColumns = new List&lt;string&gt; { "ID" },
///     Columns = new List&lt;Column&gt;
///     {
///         new() { Name = "ID", DataType = "int", IsPrimaryKey = true },
///         new() { Name = "Email", DataType = "nvarchar", MaxLength = 100 },
///         new() { Name = "Name", DataType = "nvarchar", MaxLength = 200 }
///     },
///     Indexes = new List&lt;Index&gt;
///     {
///         new() { Name = "IX_Customer_Email", IsUnique = true, Columns = new() { "Email" } }
///     }
/// };
///
/// string repositoryCode = await generator.GenerateAsync(customerTable);
///
/// // Output: Complete CustomerRepository.cs with:
/// // - Constructor with IDbConnection and ILogger
/// // - GetByIdAsync implementation calling SP_GetCustomerByID
/// // - GetAllAsync implementation with paging
/// // - AddAsync calling SP_AddCustomer
/// // - UpdateAsync calling SP_UpdateCustomer
/// // - DeleteAsync calling SP_DeleteCustomer
/// // - GetByEmailAsync calling SP_GetCustomerByEmail
/// // - ExistsAsync implementation
/// </code>
/// </example>
public interface IRepositoryGenerator
{
    /// <summary>
    /// Generates the repository implementation code for a given table.
    /// </summary>
    /// <param name="table">The table metadata containing columns, indexes, and relationships.</param>
    /// <param name="rootNamespace">The root namespace for the generated code (e.g., "MyApp"). Defaults to "YourApp".</param>
    /// <returns>A task that represents the asynchronous operation. The task result contains the generated C# class code as a string.</returns>
    /// <exception cref="ArgumentNullException">Thrown when <paramref name="table"/> is null.</exception>
    /// <exception cref="InvalidOperationException">Thrown when the table has no primary key defined.</exception>
    /// <remarks>
    /// <para>
    /// This method generates a complete repository implementation class that:
    /// </para>
    /// <list type="number">
    /// <item>Implements the corresponding repository interface</item>
    /// <item>Uses Dapper for all stored procedure calls</item>
    /// <item>Includes proper error handling and logging</item>
    /// <item>Manages database connections properly</item>
    /// <item>Supports cancellation tokens</item>
    /// <item>Maps between database types and .NET types</item>
    /// </list>
    /// <para>
    /// <strong>Generated Method Structure:</strong>
    /// </para>
    /// <code>
    /// public async Task&lt;Customer?&gt; GetByIdAsync(int id, CancellationToken cancellationToken = default)
    /// {
    ///     _logger.LogDebug("Getting Customer by ID: {Id}", id);
    ///
    ///     try
    ///     {
    ///         var result = await _connection.QueryFirstOrDefaultAsync&lt;Customer&gt;(
    ///             "SP_GetCustomerByID",
    ///             new { ID = id },
    ///             commandType: CommandType.StoredProcedure);
    ///
    ///         _logger.LogDebug("Retrieved Customer: {Found}", result != null);
    ///         return result;
    ///     }
    ///     catch (Exception ex)
    ///     {
    ///         _logger.LogError(ex, "Error getting Customer by ID: {Id}", id);
    ///         throw;
    ///     }
    /// }
    /// </code>
    /// </remarks>
    /// <example>
    /// <code>
    /// var table = new Table { Name = "Customer", PrimaryKeyColumns = new() { "ID" } };
    /// string code = await generator.GenerateAsync(table);
    ///
    /// // code contains:
    /// // public class CustomerRepository : ICustomerRepository { ... }
    /// </code>
    /// </example>
    Task<string> GenerateAsync(Table table, string rootNamespace = "YourApp");

    /// <summary>
    /// Generates the repository implementation code for a given table with full schema context for FK relationships.
    /// </summary>
    /// <param name="table">The table metadata containing columns, indexes, and relationships.</param>
    /// <param name="schema">The full database schema for detecting FK relationships.</param>
    /// <param name="rootNamespace">The root namespace for the generated code (e.g., "MyApp"). Defaults to "YourApp".</param>
    /// <returns>A task that represents the asynchronous operation. The task result contains the generated C# class code as a string.</returns>
    /// <remarks>
    /// This overload generates additional GetRelated method implementations for Master-Detail views based on FK relationships.
    /// Example: For Customer table with Orders child, generates GetOrdersAsync(customerId) implementation calling SP_GetCustomerOrders.
    /// </remarks>
    Task<string> GenerateAsync(Table table, DatabaseSchema schema, string rootNamespace = "YourApp");
}
