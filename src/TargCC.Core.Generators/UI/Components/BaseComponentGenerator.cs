// <copyright file="BaseComponentGenerator.cs" company="PlaceholderCompany">
// Copyright (c) PlaceholderCompany. All rights reserved.
// </copyright>

namespace TargCC.Core.Generators.UI.Components
{
    using System;
    using System.Collections.Generic;
    using System.Globalization;
    using System.Linq;
    using System.Text;
    using System.Threading.Tasks;
    using Microsoft.Extensions.Logging;
    using TargCC.Core.Interfaces.Models;

    /// <summary>
    /// Base class for React component generators.
    /// </summary>
    public abstract class BaseComponentGenerator : BaseUIGenerator, IComponentGenerator
    {
        private static readonly Action<ILogger, ComponentType, string, Exception?> LogGeneratingComponent =
            LoggerMessage.Define<ComponentType, string>(
                LogLevel.Information,
                new EventId(300, nameof(LogGeneratingComponent)),
                "Generating {ComponentType} component for table {TableName}");

        /// <summary>
        /// Initializes a new instance of the <see cref="BaseComponentGenerator"/> class.
        /// </summary>
        /// <param name="logger">Logger instance.</param>
        protected BaseComponentGenerator(ILogger logger)
            : base(logger)
        {
        }

        /// <inheritdoc/>
        public abstract ComponentType ComponentType { get; }

        /// <inheritdoc/>
        public override UIGeneratorType GeneratorType => UIGeneratorType.ReactComponents;

        /// <summary>
        /// Generates a React component for a table.
        /// </summary>
        /// <param name="table">Table metadata.</param>
        /// <param name="schema">Database schema.</param>
        /// <param name="config">Configuration.</param>
        /// <returns>Generated component code.</returns>
        public abstract Task<string> GenerateAsync(Table table, DatabaseSchema schema, ComponentGeneratorConfig config);

        /// <inheritdoc/>
        public override async Task<string> GenerateAsync(Table table, DatabaseSchema schema, UIGeneratorConfig config)
        {
            ArgumentNullException.ThrowIfNull(table);
            ArgumentNullException.ThrowIfNull(schema);
            ArgumentNullException.ThrowIfNull(config);

            var componentConfig = new ComponentGeneratorConfig
            {
                OutputDirectory = config.OutputDirectory,
            };

            return await GenerateAsync(table, schema, componentConfig).ConfigureAwait(false);
        }

        /// <summary>
        /// Generates a component file header.
        /// </summary>
        /// <param name="tableName">Table name.</param>
        /// <returns>Header comment.</returns>
        protected static string GenerateComponentHeader(string tableName)
        {
            var sb = new StringBuilder();
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine("//     This code was generated by TargCC Component Generator.");
            sb.AppendLine(CultureInfo.InvariantCulture, $"//     Table: {tableName}");
            sb.AppendLine(CultureInfo.InvariantCulture, $"//     Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();
            return sb.ToString();
        }

        /// <summary>
        /// Gets the input field type for a column based on its prefix and data type.
        /// </summary>
        /// <param name="column">Column metadata.</param>
        /// <returns>Field type descriptor.</returns>
        protected static ComponentFieldType GetComponentFieldType(Column column)
        {
            var (prefix, _) = SplitPrefix(column.Name);
            var sqlType = column.DataType.ToUpperInvariant();

            return prefix switch
            {
                "ENO" => new ComponentFieldType { InputType = "password", ComponentName = "TextField" },
                "LKP" => new ComponentFieldType { InputType = "select", ComponentName = "Select" },
                "LOC" => new ComponentFieldType { InputType = "textarea", ComponentName = "TextField", Multiline = true },
                "ENM" => new ComponentFieldType { InputType = "select", ComponentName = "Select" },
                "SPL" => new ComponentFieldType { InputType = "tags", ComponentName = "Autocomplete" },
                "UPL" => new ComponentFieldType { InputType = "file", ComponentName = "FileUpload" },
                "CLC" => new ComponentFieldType { InputType = "readonly", ComponentName = "Typography", IsReadOnly = true },
                "BLG" => new ComponentFieldType { InputType = "readonly", ComponentName = "Typography", IsReadOnly = true },
                "AGG" => new ComponentFieldType { InputType = "readonly", ComponentName = "Typography", IsReadOnly = true },
                "SCB" => new ComponentFieldType { InputType = "hidden", ComponentName = "Hidden", IsReadOnly = true },
                _ => GetDefaultFieldType(sqlType),
            };
        }

        /// <summary>
        /// Gets validation rules for a column.
        /// </summary>
        /// <param name="column">Column metadata.</param>
        /// <returns>Validation rules as object properties.</returns>
        protected static IReadOnlyList<string> GetValidationRules(Column column)
        {
            var rules = new List<string>();

            // Required rule
            if (!column.IsNullable && !column.IsPrimaryKey && !column.IsIdentity)
            {
                var fieldName = GetPropertyName(column.Name);
                rules.Add($"required: '{fieldName} is required'");
            }

            // MaxLength rule for string types
            if (column.MaxLength.HasValue && column.MaxLength.Value > 0)
            {
                rules.Add(string.Create(CultureInfo.InvariantCulture, $"maxLength: {{ value: {column.MaxLength.Value}, message: 'Maximum length is {column.MaxLength.Value}' }}"));
            }

            // Pattern validation
            var pattern = GetValidationPattern(column);
            if (!string.IsNullOrEmpty(pattern))
            {
                rules.Add(pattern);
            }

            return rules;
        }

        /// <summary>
        /// Formats a value for display in detail view.
        /// </summary>
        /// <param name="column">Column metadata.</param>
        /// <param name="value">Value expression (e.g., "entity.name").</param>
        /// <returns>Formatted value expression.</returns>
        protected static string FormatValueForDisplay(Column column, string value)
        {
            var (prefix, _) = SplitPrefix(column.Name);
            var sqlType = column.DataType.ToUpperInvariant();

            return prefix switch
            {
                "ENO" => "'********'", // Hide passwords
                "LKP" => $"{value}Text || {value}Code",
                "LOC" => $"{value}Localized || {value}",
                _ => FormatByDataType(sqlType, value),
            };
        }

        private static ComponentFieldType GetDefaultFieldType(string sqlType)
        {
            if (sqlType.Contains("BIT", StringComparison.Ordinal))
            {
                return new ComponentFieldType { InputType = "checkbox", ComponentName = "Checkbox" };
            }

            if (sqlType.Contains("INT", StringComparison.Ordinal) ||
                sqlType.Contains("DECIMAL", StringComparison.Ordinal) ||
                sqlType.Contains("NUMERIC", StringComparison.Ordinal) ||
                sqlType.Contains("MONEY", StringComparison.Ordinal))
            {
                return new ComponentFieldType { InputType = "number", ComponentName = "TextField" };
            }

            if (sqlType.Contains("DATE", StringComparison.Ordinal) ||
                sqlType.Contains("TIME", StringComparison.Ordinal))
            {
                return new ComponentFieldType { InputType = "date", ComponentName = "DatePicker" };
            }

            if (sqlType.Contains("TEXT", StringComparison.Ordinal))
            {
                return new ComponentFieldType { InputType = "textarea", ComponentName = "TextField", Multiline = true };
            }

            return new ComponentFieldType { InputType = "text", ComponentName = "TextField" };
        }

        private static string GetValidationPattern(Column column)
        {

            // Email pattern for email columns
            if (column.Name.Contains("email", StringComparison.OrdinalIgnoreCase))
            {
                return "pattern: { value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}$/i, message: 'Invalid email address' }";
            }

            // URL pattern for URL columns
            if (column.Name.Contains("url", StringComparison.OrdinalIgnoreCase) ||
                column.Name.Contains("website", StringComparison.OrdinalIgnoreCase))
            {
                return "pattern: { value: /^https?:\\/\\/.+/, message: 'Invalid URL' }";
            }

            // Phone pattern for phone columns
            if (column.Name.Contains("phone", StringComparison.OrdinalIgnoreCase) ||
                column.Name.Contains("mobile", StringComparison.OrdinalIgnoreCase))
            {
                return "pattern: { value: /^[0-9+\\-()\\s]+$/, message: 'Invalid phone number' }";
            }

            return string.Empty;
        }

        private static string FormatByDataType(string sqlType, string value)
        {
            if (sqlType.Contains("DATE", StringComparison.Ordinal))
            {
                return $"new Date({value}).toLocaleDateString()";
            }

            if (sqlType.Contains("TIME", StringComparison.Ordinal))
            {
                return $"new Date({value}).toLocaleString()";
            }

            if (sqlType.Contains("MONEY", StringComparison.Ordinal))
            {
                return $"new Intl.NumberFormat('en-US', {{ style: 'currency', currency: 'USD' }}).format({value})";
            }

            if (sqlType.Contains("DECIMAL", StringComparison.Ordinal) ||
                sqlType.Contains("NUMERIC", StringComparison.Ordinal))
            {
                return $"{value}.toFixed(2)";
            }

            if (sqlType.Contains("BIT", StringComparison.Ordinal))
            {
                return $"{value} ? 'Yes' : 'No'";
            }

            return value;
        }

        /// <summary>
        /// Logs component generation start.
        /// </summary>
        /// <param name="tableName">Table name.</param>
        protected void LogComponentGeneration(string tableName)
        {
            LogGeneratingComponent(Logger, ComponentType, tableName, null);
        }
    }
}
