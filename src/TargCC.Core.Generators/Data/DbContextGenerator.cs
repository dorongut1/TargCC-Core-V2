using System.Linq;

namespace TargCC.Core.Generators.Data;

using System.Globalization;
using System.Text;
using Microsoft.Extensions.Logging;
using TargCC.Core.Generators.Common;
using TargCC.Core.Interfaces.Models;

/// <summary>
/// Generates Entity Framework Core DbContext classes from database schema metadata.
/// </summary>
/// <remarks>
/// <para>
/// This generator creates the main ApplicationDbContext class that serves as the entry point
/// for Entity Framework Core. The generated DbContext includes DbSet properties for all entities,
/// proper dependency injection setup, and applies entity configurations from separate classes.
/// </para>
/// <para>
/// <strong>Key Responsibilities:</strong>
/// </para>
/// <list type="bullet">
/// <item><description>Generate DbSet properties with correct naming (pluralized)</description></item>
/// <item><description>Create constructor accepting DbContextOptions</description></item>
/// <item><description>Configure OnModelCreating to apply entity configurations</description></item>
/// <item><description>Include comprehensive XML documentation</description></item>
/// <item><description>Follow EF Core best practices</description></item>
/// </list>
/// </remarks>
public class DbContextGenerator : IDbContextGenerator
{
    // LoggerMessage delegates for high performance logging
    private static readonly Action<ILogger, int, Exception?> LogGeneratingDbContext =
        LoggerMessage.Define<int>(
            LogLevel.Information,
            new EventId(1, nameof(GenerateAsync)),
            "Generating DbContext with {TableCount} tables");

    private static readonly Action<ILogger, int, Exception?> LogDbContextGenerated =
        LoggerMessage.Define<int>(
            LogLevel.Information,
            new EventId(2, nameof(GenerateAsync)),
            "Successfully generated DbContext with {TableCount} DbSets");

    private readonly ILogger<DbContextGenerator> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="DbContextGenerator"/> class.
    /// </summary>
    /// <param name="logger">Logger for tracking generation process.</param>
    public DbContextGenerator(ILogger<DbContextGenerator> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public async Task<string> GenerateAsync(DatabaseSchema schema)
    {
        ArgumentNullException.ThrowIfNull(schema);

        if (schema.Tables == null || schema.Tables.Count == 0)
        {
            throw new InvalidOperationException("Schema must contain at least one table.");
        }

        LogGeneratingDbContext(_logger, schema.Tables.Count, null);

        var sb = new StringBuilder();

        // Add file header
        GenerateFileHeader(sb, schema);

        // Add using statements
        GenerateUsings(sb);

        // Start namespace
        sb.AppendLine("namespace TargCC.Infrastructure.Data;");
        sb.AppendLine();

        // Add class documentation
        GenerateClassDocumentation(sb, schema);

        // Start class
        sb.AppendLine("public class ApplicationDbContext : DbContext");
        sb.AppendLine("{");

        // Generate DbSet properties
        GenerateDbSets(sb, schema);

        // Generate constructor
        GenerateConstructor(sb);

        // Generate OnModelCreating
        GenerateOnModelCreating(sb);

        // Close class
        sb.AppendLine("}");

        LogDbContextGenerated(_logger, schema.Tables.Count, null);

        return await Task.FromResult(sb.ToString());
    }

    /// <summary>
    /// Generates the file header with auto-generation warning.
    /// </summary>
    private static void GenerateFileHeader(StringBuilder sb, DatabaseSchema schema)
    {
        sb.AppendLine("// <auto-generated>");
        sb.AppendLine("//     This code was generated by TargCC.Core.Generators v2.0");
        sb.AppendLine(CultureInfo.InvariantCulture, $"//     Generated from database: {schema.DatabaseName}");
        sb.AppendLine(CultureInfo.InvariantCulture, $"//     Generation date: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        sb.AppendLine("//");
        sb.AppendLine("//     Changes to this file may cause incorrect behavior and will be lost if");
        sb.AppendLine("//     the code is regenerated.");
        sb.AppendLine("// </auto-generated>");
        sb.AppendLine();
    }

    /// <summary>
    /// Generates using statements.
    /// </summary>
    private static void GenerateUsings(StringBuilder sb)
    {
        sb.AppendLine("using System.Reflection;");
        sb.AppendLine("using Microsoft.EntityFrameworkCore;");
        sb.AppendLine("using TargCC.Domain.Entities;");
        sb.AppendLine();
    }

    /// <summary>
    /// Generates class-level XML documentation.
    /// </summary>
    private static void GenerateClassDocumentation(StringBuilder sb, DatabaseSchema schema)
    {
        sb.AppendLine("/// <summary>");
        sb.AppendLine(CultureInfo.InvariantCulture, $"/// Entity Framework Core DbContext for {schema.DatabaseName} database.");
        sb.AppendLine("/// </summary>");
        sb.AppendLine("/// <remarks>");
        sb.AppendLine("/// <para>");
        sb.AppendLine("/// This DbContext provides access to all entities in the database through DbSet properties.");
        sb.AppendLine("/// Entity configurations are applied through separate IEntityTypeConfiguration classes.");
        sb.AppendLine("/// </para>");
        sb.AppendLine("/// <para>");
        sb.AppendLine(CultureInfo.InvariantCulture, $"/// <strong>Database:</strong> {schema.DatabaseName}");
        sb.AppendLine("/// </para>");
        sb.AppendLine("/// <para>");
        sb.AppendLine(CultureInfo.InvariantCulture, $"/// <strong>Tables:</strong> {schema.Tables.Count}");
        sb.AppendLine("/// </para>");
        sb.AppendLine("/// </remarks>");
    }

    /// <summary>
    /// Generates DbSet properties for all tables.
    /// </summary>
    private static void GenerateDbSets(StringBuilder sb, DatabaseSchema schema)
    {
        sb.AppendLine("    #region DbSets");
        sb.AppendLine();
        foreach (var table in schema.Tables.OrderBy(t => t.Name))
        {
            // Use PascalCase conversion for consistency with other generators
            var entityName = API.BaseApiGenerator.GetClassName(table.Name);
            var dbSetName = CodeGenerationHelpers.MakePlural(entityName); // e.g., Customer â†’ Customers

            sb.AppendLine("    /// <summary>");
            sb.AppendLine(CultureInfo.InvariantCulture, $"    /// Gets or sets the DbSet for {entityName} entities.");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine(CultureInfo.InvariantCulture, $"    public DbSet<{entityName}> {dbSetName} {{ get; set; }} = null!;");
            sb.AppendLine();
        }

        sb.AppendLine("    #endregion");
        sb.AppendLine();
    }

    /// <summary>
    /// Generates the DbContext constructor.
    /// </summary>
    private static void GenerateConstructor(StringBuilder sb)
    {
        sb.AppendLine("    #region Constructor");
        sb.AppendLine();
        sb.AppendLine("    /// <summary>");
        sb.AppendLine("    /// Initializes a new instance of the <see cref=\"ApplicationDbContext\"/> class.");
        sb.AppendLine("    /// </summary>");
        sb.AppendLine("    /// <param name=\"options\">The options to be used by the DbContext.</param>");
        sb.AppendLine("    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)");
        sb.AppendLine("        : base(options)");
        sb.AppendLine("    {");
        sb.AppendLine("    }");
        sb.AppendLine();
        sb.AppendLine("    #endregion");
        sb.AppendLine();
    }

    /// <summary>
    /// Generates the OnModelCreating method.
    /// </summary>
    private static void GenerateOnModelCreating(StringBuilder sb)
    {
        sb.AppendLine("    #region Configuration");
        sb.AppendLine();
        sb.AppendLine("    /// <summary>");
        sb.AppendLine("    /// Configures the entity model using Fluent API.");
        sb.AppendLine("    /// </summary>");
        sb.AppendLine("    /// <param name=\"modelBuilder\">The builder being used to construct the model for this context.</param>");
        sb.AppendLine("    /// <remarks>");
        sb.AppendLine("    /// This method applies all entity configurations from separate IEntityTypeConfiguration classes");
        sb.AppendLine("    /// found in the current assembly. This allows for organized configuration management.");
        sb.AppendLine("    /// </remarks>");
        sb.AppendLine("    protected override void OnModelCreating(ModelBuilder modelBuilder)");
        sb.AppendLine("    {");
        sb.AppendLine("        ArgumentNullException.ThrowIfNull(modelBuilder);");
        sb.AppendLine();
        sb.AppendLine("        // Apply all entity configurations from the assembly");
        sb.AppendLine("        modelBuilder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());");
        sb.AppendLine();
        sb.AppendLine("        base.OnModelCreating(modelBuilder);");
        sb.AppendLine("    }");
        sb.AppendLine();
        sb.AppendLine("    #endregion");
    }
}
