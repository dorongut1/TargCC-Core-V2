import { describe, it, expect } from 'vitest';
import { generateMockCode, mockCodeFiles } from '../../utils/mockCode';

describe('mockCode Utility', () => {
  const testTableName = 'Customer';

  describe('generateMockCode', () => {
    it('generates code for all component types', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toBeDefined();
      expect(code.repository).toBeDefined();
      expect(code.handler).toBeDefined();
      expect(code.controller).toBeDefined();
    });

    it('includes table name in entity code', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toContain('Customer');
      expect(code.entity).toContain('public class Customer');
    });

    it('includes table name in repository code', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.repository).toContain('ICustomerRepository');
      expect(code.repository).toContain('CustomerRepository');
    });

    it('includes table name in handler code', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.handler).toContain('GetCustomerQuery');
      expect(code.handler).toContain('GetCustomerQueryHandler');
    });

    it('includes table name in controller code', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.controller).toContain('CustomerController');
    });

    it('generates valid C# entity syntax', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toContain('namespace TargCC.Domain.Entities');
      expect(code.entity).toContain('public int Id { get; set; }');
      expect(code.entity).toContain('public string Name { get; set; }');
      expect(code.entity).toContain('public DateTime CreatedAt { get; set; }');
    });

    it('generates valid C# repository interface', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.repository).toContain('public interface ICustomerRepository');
      expect(code.repository).toContain('Task<Customer?> GetByIdAsync(int id)');
      expect(code.repository).toContain('Task<IEnumerable<Customer>> GetAllAsync()');
    });

    it('generates repository implementation', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.repository).toContain('public class CustomerRepository : ICustomerRepository');
      expect(code.repository).toContain('private readonly IDbConnection _connection');
    });

    it('includes XML documentation comments', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toContain('/// <summary>');
      expect(code.entity).toContain('/// </summary>');
      expect(code.entity).toContain('Generated by TargCC Core V2');
    });

    it('includes proper namespaces for all components', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toContain('namespace TargCC.Domain.Entities');
      expect(code.repository).toContain('namespace TargCC.Infrastructure.Repositories');
      expect(code.handler).toContain('namespace TargCC.Application.Customers.Queries');
      expect(code.controller).toContain('namespace TargCC.API.Controllers');
    });

    it('generates CQRS query handlers', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.handler).toContain('public record GetCustomerQuery');
      expect(code.handler).toContain('IRequest<Customer?>');
      expect(code.handler).toContain('IRequestHandler<GetCustomerQuery');
    });

    it('generates API controller with routes', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.controller).toContain('[ApiController]');
      expect(code.controller).toContain('[Route("api/[controller]")]');
      expect(code.controller).toContain('[HttpGet("{id}")]');
      expect(code.controller).toContain('[HttpPost]');
    });

    it('includes error handling in controller', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.controller).toContain('if (result == null)');
      expect(code.controller).toContain('return NotFound()');
    });

    it('includes logging in handler', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.handler).toContain('ILogger<GetCustomerQueryHandler>');
      expect(code.handler).toContain('_logger.LogInformation');
    });

    it('generates different code for different table names', () => {
      const code1 = generateMockCode('Product');
      const code2 = generateMockCode('Order');
      
      expect(code1.entity).toContain('Product');
      expect(code1.entity).not.toContain('Order');
      
      expect(code2.entity).toContain('Order');
      expect(code2.entity).not.toContain('Product');
    });
  });

  describe('mockCodeFiles', () => {
    it('returns array of 4 code files', () => {
      const files = mockCodeFiles(testTableName);
      
      expect(files).toHaveLength(4);
    });

    it('includes entity file', () => {
      const files = mockCodeFiles(testTableName);
      
      const entityFile = files.find(f => f.name === 'Customer.cs');
      expect(entityFile).toBeDefined();
      expect(entityFile?.language).toBe('csharp');
    });

    it('includes repository file', () => {
      const files = mockCodeFiles(testTableName);
      
      const repoFile = files.find(f => f.name === 'ICustomerRepository.cs');
      expect(repoFile).toBeDefined();
      expect(repoFile?.language).toBe('csharp');
    });

    it('includes handler file', () => {
      const files = mockCodeFiles(testTableName);
      
      const handlerFile = files.find(f => f.name === 'GetCustomerQueryHandler.cs');
      expect(handlerFile).toBeDefined();
      expect(handlerFile?.language).toBe('csharp');
    });

    it('includes controller file', () => {
      const files = mockCodeFiles(testTableName);
      
      const controllerFile = files.find(f => f.name === 'CustomerController.cs');
      expect(controllerFile).toBeDefined();
      expect(controllerFile?.language).toBe('csharp');
    });

    it('all files have correct structure', () => {
      const files = mockCodeFiles(testTableName);
      
      files.forEach(file => {
        expect(file).toHaveProperty('name');
        expect(file).toHaveProperty('code');
        expect(file).toHaveProperty('language');
        expect(file.language).toBe('csharp');
        expect(file.name).toMatch(/\.cs$/);
      });
    });

    it('all files contain non-empty code', () => {
      const files = mockCodeFiles(testTableName);
      
      files.forEach(file => {
        expect(file.code.length).toBeGreaterThan(0);
        expect(file.code.trim()).not.toBe('');
      });
    });

    it('generates consistent file names', () => {
      const files = mockCodeFiles(testTableName);
      
      const fileNames = files.map(f => f.name);
      expect(fileNames).toContain('Customer.cs');
      expect(fileNames).toContain('ICustomerRepository.cs');
      expect(fileNames).toContain('GetCustomerQueryHandler.cs');
      expect(fileNames).toContain('CustomerController.cs');
    });

    it('works with different table names', () => {
      const files = mockCodeFiles('Product');
      
      expect(files[0].name).toBe('Product.cs');
      expect(files[1].name).toBe('IProductRepository.cs');
      expect(files[2].name).toBe('GetProductQueryHandler.cs');
      expect(files[3].name).toBe('ProductController.cs');
    });

    it('maintains correct order of files', () => {
      const files = mockCodeFiles(testTableName);
      
      expect(files[0].name).toBe('Customer.cs');
      expect(files[1].name).toBe('ICustomerRepository.cs');
      expect(files[2].name).toBe('GetCustomerQueryHandler.cs');
      expect(files[3].name).toBe('CustomerController.cs');
    });
  });

  describe('Edge Cases', () => {
    it('handles single letter table names', () => {
      const files = mockCodeFiles('A');
      
      expect(files[0].name).toBe('A.cs');
      expect(files[0].code).toContain('public class A');
    });

    it('handles table names with numbers', () => {
      const files = mockCodeFiles('Table123');
      
      expect(files[0].name).toBe('Table123.cs');
      expect(files[0].code).toContain('public class Table123');
    });

    it('handles PascalCase table names', () => {
      const files = mockCodeFiles('CustomerOrder');
      
      expect(files[0].code).toContain('public class CustomerOrder');
      expect(files[1].code).toContain('ICustomerOrderRepository');
    });

    it('handles lowercase table names', () => {
      const files = mockCodeFiles('customer');
      
      expect(files[0].code).toContain('public class customer');
    });

    it('handles table names with underscores', () => {
      const files = mockCodeFiles('Customer_Order');
      
      expect(files[0].name).toBe('Customer_Order.cs');
    });
  });

  describe('Code Quality', () => {
    it('generates properly formatted C# code', () => {
      const code = generateMockCode(testTableName);
      
      // Check for proper indentation markers
      expect(code.entity).toContain('{');
      expect(code.entity).toContain('}');
      expect(code.entity).toContain(';');
    });

    it('includes proper property syntax', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.entity).toMatch(/public \w+ \w+ \{ get; set; \}/);
    });

    it('includes async/await patterns', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.repository).toContain('async Task');
      expect(code.repository).toContain('await');
    });

    it('includes dependency injection', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.repository).toContain('public CustomerRepository(IDbConnection connection)');
      expect(code.controller).toContain('public CustomerController(IMediator mediator)');
    });

    it('includes proper HTTP method attributes', () => {
      const code = generateMockCode(testTableName);
      
      expect(code.controller).toContain('[HttpGet]');
      expect(code.controller).toContain('[HttpPost]');
      expect(code.controller).toContain('[HttpPut');
      expect(code.controller).toContain('[HttpDelete');
    });
  });
});
