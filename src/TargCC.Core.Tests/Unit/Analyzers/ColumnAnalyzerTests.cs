// <copyright file="ColumnAnalyzerTests.cs" company="PlaceholderCompany">
// Copyright (c) PlaceholderCompany. All rights reserved.
// </copyright>

namespace TargCC.Core.Tests.Unit.Analyzers;

using System;
using System.Collections.Generic;
using System.Data;
using System.Threading.Tasks;
using Dapper;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Logging;
using Moq;
using TargCC.Core.Analyzers.Database;
using TargCC.Core.Interfaces.Models;
using TargCC.Core.Tests.TestHelpers;
using Xunit;

/// <summary>
/// Unit tests for ColumnAnalyzer.
/// Tests all column analysis functionality including prefixes and extended properties.
/// </summary>
public class ColumnAnalyzerTests
{
    private readonly Mock<ILogger> loggerMock;
    private readonly ColumnAnalyzer analyzer;
    private const string TestConnectionString = "Server=.;Database=TestDb;Integrated Security=true;";

    /// <summary>
    /// Initializes a new instance of the <see cref="ColumnAnalyzerTests"/> class.
    /// </summary>
    public ColumnAnalyzerTests()
    {
        this.loggerMock = new Mock<ILogger>();
        this.analyzer = new ColumnAnalyzer(TestConnectionString, this.loggerMock.Object);
    }

    #region Basic Column Analysis Tests

    /// <summary>
    /// Test that AnalyzeColumnsAsync throws ArgumentNullException when schema is null.
    /// </summary>
    /// <returns>A <see cref="Task"/> representing the asynchronous unit test.</returns>
    [Fact]
    public async Task AnalyzeColumnsAsync_NullSchema_ThrowsArgumentNullException()
    {
        // Act & Assert
        await Assert.ThrowsAsync<ArgumentNullException>(
            () => this.analyzer.AnalyzeColumnsAsync(null!, "TestTable"));
    }

    /// <summary>
    /// Test that AnalyzeColumnsAsync throws ArgumentNullException when table is null.
    /// </summary>
    /// <returns>A <see cref="Task"/> representing the asynchronous unit test.</returns>
    [Fact]
    public async Task AnalyzeColumnsAsync_NullTable_ThrowsArgumentNullException()
    {
        // Act & Assert
        await Assert.ThrowsAsync<ArgumentNullException>(
            () => this.analyzer.AnalyzeColumnsAsync("dbo", null!));
    }

    #endregion

    #region Prefix Detection Tests

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies OneWayEncryption prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_EnoPrefix_ReturnsOneWayEncryption()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("eno_Password")
            .AsVarchar(64)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.OneWayEncryption, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies TwoWayEncryption prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_EntPrefix_ReturnsTwoWayEncryption()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("ent_SecretKey")
            .AsNVarchar(200)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.TwoWayEncryption, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies Localization prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_LocPrefix_ReturnsLocalization()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("loc_Description")
            .AsNVarchar(500)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.Localization, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies Calculated prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_ClcPrefix_ReturnsCalculated()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("clc_TotalAmount")
            .AsDecimal()
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.Calculated, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies BusinessLogic prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_BlgPrefix_ReturnsBusinessLogic()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("blg_AutoGenerated")
            .AsNVarchar(100)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.BusinessLogic, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies SeparateUpdate prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_SptPrefix_ReturnsSeparateUpdate()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("spt_Comments")
            .AsNVarchar(500)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.SeparateUpdate, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies Aggregate prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_AggPrefix_ReturnsAggregate()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("agg_TotalCount")
            .AsInt()
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.Aggregate, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies Lookup prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_LkpPrefix_ReturnsLookup()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("lkp_Status")
            .AsVarchar(50)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.Lookup, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix correctly identifies Enumeration prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_EnmPrefix_ReturnsEnumeration()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("enm_UserType")
            .AsVarchar(50)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.Enumeration, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix returns None for columns without prefix.
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_NoPrefix_ReturnsNone()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("CustomerName")
            .AsNVarchar(100)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert
        Assert.Equal(ColumnPrefix.None, prefix);
    }

    /// <summary>
    /// Test that DetermineColumnPrefix handles combined prefix (blg_loc_).
    /// </summary>
    [Fact]
    public void DetermineColumnPrefix_CombinedPrefix_ReturnsFirstPrefix()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("blg_loc_Description")
            .AsNVarchar(500)
            .Build();

        // Act
        var prefix = this.GetPrefixFromColumnName(column.Name);

        // Assert - First prefix should be detected (blg)
        Assert.Equal(ColumnPrefix.BusinessLogic, prefix);
    }

    #endregion

    #region SQL Type Detection Tests

    /// <summary>
    /// Test that int SQL type is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_IntType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("ID")
            .AsInt()
            .Build();

        // Act & Assert
        Assert.Equal("int", column.DataType);
        Assert.Null(column.MaxLength);
    }

    /// <summary>
    /// Test that varchar type with length is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_VarcharType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("Email")
            .AsVarchar(100)
            .Build();

        // Act & Assert
        Assert.Equal("varchar", column.DataType);
        Assert.Equal(100, column.MaxLength);
    }

    /// <summary>
    /// Test that nvarchar type with length is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_NvarcharType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("Name")
            .AsNVarchar(50)
            .Build();

        // Act & Assert
        Assert.Equal("nvarchar", column.DataType);
        Assert.Equal(50, column.MaxLength);
    }

    /// <summary>
    /// Test that decimal type is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_DecimalType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("Price")
            .AsDecimal()
            .Build();

        // Act & Assert
        Assert.Equal("decimal", column.DataType);
    }

    /// <summary>
    /// Test that datetime type is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_DateTimeType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("CreatedDate")
            .AsDateTime()
            .Build();

        // Act & Assert
        Assert.Equal("datetime", column.DataType);
    }

    /// <summary>
    /// Test that bit (boolean) type is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_BitType_CorrectlyIdentified()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("IsActive")
            .AsBit()
            .Build();

        // Act & Assert
        Assert.Equal("bit", column.DataType);
    }

    #endregion

    #region Nullable Detection Tests

    /// <summary>
    /// Test that nullable column is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_NullableColumn_IsNullableTrue()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("MiddleName")
            .AsNVarchar(50)
            .Nullable()
            .Build();

        // Act & Assert
        Assert.True(column.IsNullable);
    }

    /// <summary>
    /// Test that not nullable column is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_NotNullableColumn_IsNullableFalse()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("FirstName")
            .AsNVarchar(50)
            .NotNullable()
            .Build();

        // Act & Assert
        Assert.False(column.IsNullable);
    }

    #endregion

    #region Primary Key Detection Tests

    /// <summary>
    /// Test that primary key column is correctly identified.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_PrimaryKeyColumn_IsPrimaryKeyTrue()
    {
        // Arrange
        var column = ColumnBuilder.IdColumn();

        // Act & Assert
        Assert.True(column.IsPrimaryKey);
        Assert.False(column.IsNullable); // PK should be NOT NULL
    }

    #endregion

    #region Extended Properties Tests

    /// <summary>
    /// Test that ccType extended property is correctly processed.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_WithCcTypeProperty_AppliesSettings()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("TestColumn")
            .AsNVarchar(100)
            .WithCcType("blg")
            .Build();

        // Act & Assert
        Assert.NotNull(column.ExtendedProperties);
        Assert.True(column.ExtendedProperties.ContainsKey("ccType"));
        Assert.Equal("blg", column.ExtendedProperties["ccType"]);
    }

    /// <summary>
    /// Test that combined ccType (blg,clc) is correctly processed.
    /// </summary>
    [Fact]
    public void AnalyzeColumn_WithCombinedCcType_AppliesMultipleSettings()
    {
        // Arrange
        var column = new ColumnBuilder()
            .WithName("TestColumn")
            .AsNVarchar(100)
            .WithCcType("blg,clc")
            .Build();

        // Act & Assert
        Assert.NotNull(column.ExtendedProperties);
        Assert.Equal("blg,clc", column.ExtendedProperties["ccType"]);
    }

    #endregion

    #region Builder Pattern Tests

    /// <summary>
    /// Test that ColumnBuilder.IdColumn creates correct ID column.
    /// </summary>
    [Fact]
    public void IdColumn_CreatesCorrectColumn()
    {
        // Act
        var column = ColumnBuilder.IdColumn();

        // Assert
        Assert.Equal("ID", column.Name);
        Assert.Equal("int", column.DataType);
        Assert.True(column.IsPrimaryKey);
        Assert.False(column.IsNullable);
    }

    /// <summary>
    /// Test that ColumnBuilder.NameColumn creates correct Name column.
    /// </summary>
    [Fact]
    public void NameColumn_CreatesCorrectColumn()
    {
        // Act
        var column = ColumnBuilder.NameColumn();

        // Assert
        Assert.Equal("Name", column.Name);
        Assert.Equal("nvarchar", column.DataType);
        Assert.Equal(100, column.MaxLength);
        Assert.False(column.IsNullable);
    }

    /// <summary>
    /// Test that ColumnBuilder.ForeignKeyColumn creates correct FK column.
    /// </summary>
    [Fact]
    public void ForeignKeyColumn_CreatesCorrectColumn()
    {
        // Act
        var column = ColumnBuilder.ForeignKeyColumn("CustomerID");

        // Assert
        Assert.Equal("CustomerID", column.Name);
        Assert.Equal("int", column.DataType);
        Assert.False(column.IsNullable);
    }

    #endregion

    #region Helper Methods

    /// <summary>
    /// Helper method to determine prefix from column name.
    /// This simulates the DetermineColumnPrefix method in ColumnAnalyzer.
    /// </summary>
    /// <param name="columnName">The column name.</param>
    /// <returns>The detected prefix.</returns>
    private ColumnPrefix GetPrefixFromColumnName(string columnName)
    {
        if (string.IsNullOrWhiteSpace(columnName))
        {
            return ColumnPrefix.None;
        }

        return columnName.ToLowerInvariant() switch
        {
            _ when columnName.StartsWith("eno_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.OneWayEncryption,
            _ when columnName.StartsWith("ent_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.TwoWayEncryption,
            _ when columnName.StartsWith("loc_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Localization,
            _ when columnName.StartsWith("clc_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Calculated,
            _ when columnName.StartsWith("blg_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.BusinessLogic,
            _ when columnName.StartsWith("spt_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.SeparateUpdate,
            _ when columnName.StartsWith("agg_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Aggregate,
            _ when columnName.StartsWith("lkp_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Lookup,
            _ when columnName.StartsWith("enm_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Enumeration,
            _ when columnName.StartsWith("fui_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.FakeUniqueIndex,
            _ when columnName.StartsWith("upl_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.Upload,
            _ when columnName.StartsWith("spl_", StringComparison.OrdinalIgnoreCase) => ColumnPrefix.SeparateList,
            _ => ColumnPrefix.None,
        };
    }

    #endregion
}
