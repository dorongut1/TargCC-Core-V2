// <auto-generated>
// This code was generated by TargCC Code Generator.
// Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>

using Microsoft.Extensions.Logging;
using Moq;
using TargCC.Core.Generators.Data;
using TargCC.Core.Generators.Repositories;
using TargCC.Core.Interfaces.Models;
using TargCC.Core.Tests.TestHelpers;

namespace TargCC.Core.Tests.Integration;

/// <summary>
/// Base class for integration tests with common setup and helpers.
/// </summary>
public abstract class IntegrationTestBase : IDisposable
{
    protected readonly ILogger<RepositoryInterfaceGenerator> RepoInterfaceLogger;
    protected readonly ILogger<RepositoryGenerator> RepoLogger;
    protected readonly ILogger<DbContextGenerator> DbContextLogger;
    protected readonly ILogger<EntityConfigurationGenerator> EntityConfigLogger;
    protected readonly DatabaseSchemaBuilder SchemaBuilder;

    protected IntegrationTestBase()
    {
        // Setup typed loggers
        RepoInterfaceLogger = new Mock<ILogger<RepositoryInterfaceGenerator>>().Object;
        RepoLogger = new Mock<ILogger<RepositoryGenerator>>().Object;
        DbContextLogger = new Mock<ILogger<DbContextGenerator>>().Object;
        EntityConfigLogger = new Mock<ILogger<EntityConfigurationGenerator>>().Object;

        // Setup schema builder
        SchemaBuilder = new DatabaseSchemaBuilder();
    }

    /// <summary>
    /// Creates a test table with basic structure.
    /// </summary>
    protected Table CreateTestTable(string tableName = "Customer")
    {
        return new TableBuilder().WithName(tableName)
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("Name", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("Email", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("Phone", "NVARCHAR", maxLength: 20)
            .WithColumn("CreatedAt", "DATETIME", isNullable: false)
            .WithColumn("UpdatedAt", "DATETIME")
            .WithIndex("IX_Customer_Email", isUnique: true, columns: new[] { "Email" })
            .Build();
    }

    /// <summary>
    /// Creates a test table with aggregates.
    /// </summary>
    protected Table CreateTableWithAggregates(string tableName = "Customer")
    {
        return new TableBuilder().WithName(tableName)
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("Name", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("Email", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("agg_OrderCount", "INT", isNullable: false)
            .WithColumn("agg_TotalSpent", "DECIMAL", precision: 18, scale: 2, isNullable: false)
            .Build();
    }

    /// <summary>
    /// Creates a test table with special columns.
    /// </summary>
    protected Table CreateTableWithSpecialColumns(string tableName = "User")
    {
        return new TableBuilder().WithName(tableName)
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("Username", "NVARCHAR", maxLength: 50, isNullable: false)
            .WithColumn("Email", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("eno_Password", "VARCHAR", maxLength: 64, isNullable: false)
            .WithColumn("ent_CreditCard", "NVARCHAR", maxLength: 500)
            .WithColumn("lkp_Status", "VARCHAR", maxLength: 10)
            .Build();
    }

    /// <summary>
    /// Creates a test schema with multiple related tables.
    /// </summary>
    protected DatabaseSchema CreateTestSchema()
    {
        var customerTable = new TableBuilder().WithName("Customer")
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("Name", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("Email", "NVARCHAR", maxLength: 100, isNullable: false)
            .WithColumn("agg_OrderCount", "INT", isNullable: false)
            .Build();

        var orderTable = new TableBuilder().WithName("Order")
            .WithColumn("ID", "INT", isPrimaryKey: true, isIdentity: true)
            .WithColumn("CustomerID", "INT", isNullable: false, isForeignKey: true)
            .WithColumn("OrderDate", "DATETIME", isNullable: false)
            .WithColumn("TotalAmount", "DECIMAL", precision: 18, scale: 2, isNullable: false)
            .Build();
        
        // Add foreign key relationship
        orderTable.Relationships.Add(new Relationship
        {
            ConstraintName = "FK_Order_Customer",
            Name = "FK_Order_Customer",
            ParentTable = "Customer",
            ParentColumn = "ID",
            ChildTable = "Order",
            ChildColumn = "CustomerID",
            DeleteAction = "NO ACTION"
        });

        return SchemaBuilder
            .WithTable(customerTable)
            .WithTable(orderTable)
            .Build();
    }

    public void Dispose()
    {
        // Cleanup if needed
        GC.SuppressFinalize(this);
    }
}
